{
  "tasks": [
    {
      "id": "R1-code",
      "name": "Remove library panics (critical crates)",
      "type": "code",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Replace .unwrap() panics with Result-based error handling in broker, world, telemetry-lib, and forwarder; add rich context and keep APIs stable.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/broker/src",
        "crates/world/src",
        "crates/telemetry-lib/src",
        "crates/forwarder/src",
        "CHANGELOG.md"
      ],
      "acceptance_criteria": [
        "All .unwrap() usages in library code for the four crates are converted to Result-based flows with anyhow::Context messaging.",
        "Public APIs remain backward-compatible or are documented with deprecation notes; no new panics introduced.",
        "Docs/CHANGELOG entries capture panic removal and error surface changes.",
        "cargo fmt && cargo clippy --workspace --all-targets -- -D warnings are clean for touched crates."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R1-code to in_progress, log START entry, commit docs update",
        "Create task branch cr-r1-panics-code",
        "Create worktree wt/cr-r1-panics-code from that branch"
      ],
      "end_checklist": [
        "Ensure fmt/clippy/tests per prompt are green",
        "Commit worktree changes",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry",
        "Create/confirm next kickoff prompts as required",
        "Commit docs update on feat/crate-refactor"
      ],
      "depends_on": [],
      "concurrent_with": [
        "R1-test"
      ],
      "worktree": "wt/cr-r1-panics-code",
      "integration_task": "R1-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R1-code.md"
    },
    {
      "id": "R1-test",
      "name": "Panic guards for critical crates",
      "type": "test",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Add panic-focused tests for broker, world, telemetry-lib, and forwarder to ensure poisoned locks and error paths return Result instead of panicking.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/broker/tests",
        "crates/world/tests",
        "crates/telemetry-lib/tests",
        "crates/forwarder/tests"
      ],
      "acceptance_criteria": [
        "Tests cover poisoned lock scenarios and failure modes for each crate\u2019s public API, asserting non-panicking behavior.",
        "Any new test fixtures or helpers are isolated to test modules; production code remains untouched.",
        "cargo fmt && targeted cargo test suites for the four crates pass and are logged in session_log.md.",
        "Kickoff prompts for R1-integ and R2-code/test are authored as required."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R1-test to in_progress, log START entry, commit docs update",
        "Create task branch cr-r1-panics-test",
        "Create worktree wt/cr-r1-panics-test from that branch"
      ],
      "end_checklist": [
        "Ensure fmt/tests per prompt are green",
        "Commit worktree changes",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry",
        "Create/confirm next kickoff prompts as required",
        "Commit docs update on feat/crate-refactor"
      ],
      "depends_on": [],
      "concurrent_with": [
        "R1-code"
      ],
      "worktree": "wt/cr-r1-panics-test",
      "integration_task": "R1-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R1-test.md"
    },
    {
      "id": "R1-integ",
      "name": "Integrate panic remediation",
      "type": "integration",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Merge panic-remediation code/test worktrees, resolve conflicts, and ensure fmt/clippy/tests pass across the affected crates.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "crates/broker",
        "crates/world",
        "crates/telemetry-lib",
        "crates/forwarder"
      ],
      "acceptance_criteria": [
        "wt/cr-r1-panics-integ merges R1-code/test with clean fmt/clippy/test runs.",
        "feat/crate-refactor contains panic-free crates plus doc/task/log updates.",
        "Kickoff prompts for R2 tasks verified/updated before ending session."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Confirm R1-code/R1-test completed",
        "Set R1-integ to in_progress, log START entry, commit docs update",
        "Create task branch cr-r1-panics-integ",
        "Create worktree wt/cr-r1-panics-integ from that branch"
      ],
      "end_checklist": [
        "Merge code/test branches into integration branch/worktree and resolve conflicts",
        "Run required fmt/clippy/tests",
        "Merge integration branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry",
        "Push or hand off"
      ],
      "depends_on": [
        "R1-code",
        "R1-test"
      ],
      "concurrent_with": [],
      "worktree": "wt/cr-r1-panics-integ",
      "integration_task": null,
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R1-integ.md"
    },
    {
      "id": "R2-code",
      "name": "Shell decomposition & PTY channelization",
      "type": "code",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Split shell/lib.rs into execution, repl, builtins, and scripts modules, replace nested Arc<Mutex> PTY handling with a channel-based pattern, and keep CLI/docs aligned.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/shell/src/lib.rs",
        "crates/shell/src/pty_exec.rs",
        "docs/USAGE.md",
        "docs/CONFIGURATION.md"
      ],
      "acceptance_criteria": [
        "shell/src/lib.rs reduced to thin public surface (~200 lines) with modules for execution/, repl/, builtins/, scripts/ as outlined in the analysis.",
        "PTY management uses channel/message passing instead of nested Arc<Mutex>; no global mutable state for PTY writers.",
        "CLI behavior preserved (help, flags), and docs updated to reflect module moves if paths referenced.",
        "cargo fmt; cargo clippy -p substrate-shell -- -D warnings; targeted cargo test -p substrate-shell (world_root/world_enable) pass."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R2-code to in_progress, update session_log.md, commit docs update",
        "Create task branch cr-r2-shell-code",
        "Create worktree wt/cr-r2-shell-code from that branch"
      ],
      "end_checklist": [
        "Ensure required fmt/lint/tests per prompt are green",
        "Commit worktree changes",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry",
        "Create/confirm next kickoff prompts as required",
        "Commit docs update on feat/crate-refactor"
      ],
      "depends_on": [
        "R1-integ"
      ],
      "concurrent_with": [
        "R2-test"
      ],
      "worktree": "wt/cr-r2-shell-code",
      "integration_task": "R2-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R2-code.md"
    },
    {
      "id": "R2-test",
      "name": "Shell test extraction & coverage",
      "type": "test",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Move shell tests out of lib.rs into tests/ modules, add coverage for the new PTY channel manager and module seams, and update fixtures.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/shell/tests",
        "crates/shell/src",
        "tests/installers/install_smoke.sh"
      ],
      "acceptance_criteria": [
        "Unit/integration tests relocated to crates/shell/tests (with common fixtures) and no remaining tests in lib.rs.",
        "Coverage added for PTY channel manager (resize/write/close) and module boundaries; no production code edits beyond test-only helpers.",
        "cargo fmt; cargo test -p substrate-shell world_root; ./tests/installers/install_smoke.sh scenarios documented in session log.",
        "Kickoff prompts for R2-integ and R3-code/test captured."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R2-test to in_progress, update session_log.md, commit docs update",
        "Create task branch cr-r2-shell-test",
        "Create worktree wt/cr-r2-shell-test from that branch"
      ],
      "end_checklist": [
        "Ensure required fmt/tests per prompt are green",
        "Commit worktree changes",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry",
        "Create/confirm next kickoff prompts as required",
        "Commit docs update on feat/crate-refactor"
      ],
      "depends_on": [
        "R1-integ"
      ],
      "concurrent_with": [
        "R2-code"
      ],
      "worktree": "wt/cr-r2-shell-test",
      "integration_task": "R2-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R2-test.md"
    },
    {
      "id": "R2-integ",
      "name": "Integrate shell decomposition",
      "type": "integration",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Merge shell decomposition code/test branches, resolve conflicts, and ensure fmt/clippy/tests plus installer smoke scripts pass.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "crates/shell",
        "tests/installers",
        "docs/USAGE.md"
      ],
      "acceptance_criteria": [
        "wt/cr-r2-shell-integ merges R2 code+tests with clean fmt/clippy/test + installer smoke results logged.",
        "feat/crate-refactor updated with integration results and doc/task/log entries committed.",
        "Kickoff prompts for R3 tasks verified/updated."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Confirm R2-code/test completed",
        "Set R2-integ to in_progress, update session_log.md, commit docs update",
        "Create task branch cr-r2-shell-integ",
        "Create worktree wt/cr-r2-shell-integ from that branch"
      ],
      "end_checklist": [
        "Merge code/test branches into integration branch/worktree and resolve conflicts",
        "Run required fmt/clippy/tests and installer smoke scenarios",
        "Merge integration branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry",
        "Push or hand off"
      ],
      "depends_on": [
        "R2-code",
        "R2-test"
      ],
      "concurrent_with": [],
      "worktree": "wt/cr-r2-shell-integ",
      "integration_task": null,
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R2-integ.md"
    },
    {
      "id": "R3-code",
      "name": "Global state & binary boundaries",
      "type": "code",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Remove broker/trace global singletons, enforce thin binaries for world-agent and host-proxy, and expose context-based constructors.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/broker/src",
        "crates/trace/src",
        "crates/world-agent/src",
        "crates/host-proxy/src"
      ],
      "acceptance_criteria": [
        "Broker/trace contexts replace global Lazy singletons; public APIs accept explicit handles.",
        "world-agent and host-proxy binaries reduced to thin mains delegating into library constructors/run loops.",
        "Docs updated for lifecycle/initialization changes; backwards compatibility maintained or clearly documented.",
        "cargo fmt; cargo clippy --workspace --all-targets -- -D warnings; targeted cargo test for broker/trace/world-agent/host-proxy pass."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R3-code to in_progress, update session_log.md, commit docs update",
        "Create task branch cr-r3-boundaries-code",
        "Create worktree wt/cr-r3-boundaries-code from that branch"
      ],
      "end_checklist": [
        "Ensure required fmt/lint/tests per prompt are green",
        "Commit worktree changes",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry",
        "Create/confirm next kickoff prompts as required",
        "Commit docs update on feat/crate-refactor"
      ],
      "depends_on": [
        "R2-integ"
      ],
      "concurrent_with": [
        "R3-test"
      ],
      "worktree": "wt/cr-r3-boundaries-code",
      "integration_task": "R3-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R3-code.md"
    },
    {
      "id": "R3-test",
      "name": "State isolation & binary harness tests",
      "type": "test",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Add tests ensuring broker/trace contexts are isolated (no shared global state) and cover world-agent/host-proxy thin binary entrypoints.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/broker/tests",
        "crates/trace/tests",
        "crates/world-agent",
        "crates/host-proxy"
      ],
      "acceptance_criteria": [
        "Tests verify independent broker/trace contexts can run in parallel without cross-talk; add mocks/helpers as needed.",
        "Binary entrypoints for world-agent/host-proxy covered by integration tests or harness scripts confirming thin main behavior.",
        "cargo fmt; targeted cargo test suites executed and logged in session_log.md.",
        "Kickoff prompt for R3-integ plus R4-code/test recorded."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R3-test to in_progress, update session_log.md, commit docs update",
        "Create task branch cr-r3-boundaries-test",
        "Create worktree wt/cr-r3-boundaries-test from that branch"
      ],
      "end_checklist": [
        "Ensure required fmt/tests per prompt are green",
        "Commit worktree changes",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry",
        "Create/confirm next kickoff prompts as required",
        "Commit docs update on feat/crate-refactor"
      ],
      "depends_on": [
        "R2-integ"
      ],
      "concurrent_with": [
        "R3-code"
      ],
      "worktree": "wt/cr-r3-boundaries-test",
      "integration_task": "R3-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R3-test.md"
    },
    {
      "id": "R3-integ",
      "name": "Integrate state/binary boundary changes",
      "type": "integration",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Merge broker/trace/world-agent/host-proxy code/test branches, resolve conflicts, and ensure fmt/clippy/tests are green.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "crates/broker",
        "crates/trace",
        "crates/world-agent",
        "crates/host-proxy"
      ],
      "acceptance_criteria": [
        "wt/cr-r3-boundaries-integ merges R3 code+tests with clean fmt/clippy/tests.",
        "feat/crate-refactor updated with integration results and doc/task/log entries committed.",
        "Kickoff prompts for R4 tasks verified/updated before end."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Confirm R3-code/test completed",
        "Set R3-integ to in_progress, update session_log.md, commit docs update",
        "Create task branch cr-r3-boundaries-integ",
        "Create worktree wt/cr-r3-boundaries-integ from that branch"
      ],
      "end_checklist": [
        "Merge code/test branches into integration branch/worktree and resolve conflicts",
        "Run required fmt/clippy/tests",
        "Merge integration branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry",
        "Push or hand off"
      ],
      "depends_on": [
        "R3-code",
        "R3-test"
      ],
      "concurrent_with": [],
      "worktree": "wt/cr-r3-boundaries-integ",
      "integration_task": null,
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R3-integ.md"
    },
    {
      "id": "R4-code",
      "name": "Polish & documentation sweep",
      "type": "code",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Split remaining single-file crates (trace, world-windows-wsl), add replay/common prelude docs, and ensure CHANGELOG reflects refactor outcomes.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/trace/src",
        "crates/world-windows-wsl/src",
        "crates/replay/src/lib.rs",
        "crates/common/src/lib.rs",
        "CHANGELOG.md"
      ],
      "acceptance_criteria": [
        "trace and world-windows-wsl crates split into modules per analysis recommendations, keeping thin lib surfaces.",
        "Replay crate gains module-level rustdoc with runnable examples; common crate exposes documented prelude if justified.",
        "CHANGELOG.md updated for refactor outcomes and any API surface notes.",
        "cargo fmt; cargo clippy --workspace --all-targets -- -D warnings; cargo test --workspace -- --nocapture (or targeted suites) pass for touched crates."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R4-code to in_progress, update session_log.md, commit docs update",
        "Create task branch cr-r4-polish-code",
        "Create worktree wt/cr-r4-polish-code from that branch"
      ],
      "end_checklist": [
        "Ensure required fmt/lint/tests per prompt are green",
        "Commit worktree changes",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry",
        "Create/confirm next kickoff prompts as required",
        "Commit docs update on feat/crate-refactor"
      ],
      "depends_on": [
        "R3-integ"
      ],
      "concurrent_with": [
        "R4-test"
      ],
      "worktree": "wt/cr-r4-polish-code",
      "integration_task": "R4-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R4-code.md"
    },
    {
      "id": "R4-test",
      "name": "Documentation & polish validation",
      "type": "test",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Add tests/doctests/property tests to cover new module splits, replay docs, and ensure benchmarks/fixtures stay stable.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/trace",
        "crates/world-windows-wsl",
        "crates/replay",
        "crates/common"
      ],
      "acceptance_criteria": [
        "Doctests/property tests added for replay docs and new module boundaries; fixtures updated without altering production code.",
        "Benchmarks or performance checks recorded when applicable, with notes in session_log.md.",
        "cargo fmt; targeted cargo test/doctest runs documented; no new clippy warnings.",
        "Kickoff prompt for R4-integ produced with references to code/test branches."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R4-test to in_progress, update session_log.md, commit docs update",
        "Create task branch cr-r4-polish-test",
        "Create worktree wt/cr-r4-polish-test from that branch"
      ],
      "end_checklist": [
        "Ensure required fmt/tests per prompt are green",
        "Commit worktree changes",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry",
        "Create/confirm next kickoff prompts as required",
        "Commit docs update on feat/crate-refactor"
      ],
      "depends_on": [
        "R3-integ"
      ],
      "concurrent_with": [
        "R4-code"
      ],
      "worktree": "wt/cr-r4-polish-test",
      "integration_task": "R4-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R4-test.md"
    },
    {
      "id": "R4-integ",
      "name": "Integrate polish/doc sweep",
      "type": "integration",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Merge polish/doc code/test branches, resolve conflicts, and ensure full fmt/clippy/tests (and relevant doctests/benches) pass.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "crates/trace",
        "crates/world-windows-wsl",
        "crates/replay",
        "crates/common"
      ],
      "acceptance_criteria": [
        "wt/cr-r4-polish-integ merges R4 code+tests with clean fmt/clippy/tests/doctests.",
        "feat/crate-refactor contains final polish changes plus updated tasks/session_log.",
        "Any remaining kickoff prompts or follow-up notes captured before ending session."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Confirm R4-code/test completed",
        "Set R4-integ to in_progress, update session_log.md, commit docs update",
        "Create task branch cr-r4-polish-integ",
        "Create worktree wt/cr-r4-polish-integ from that branch"
      ],
      "end_checklist": [
        "Merge code/test branches into integration branch/worktree and resolve conflicts",
        "Run required fmt/clippy/tests/doctests (and benches if required)",
        "Merge integration branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry",
        "Push or hand off"
      ],
      "depends_on": [
        "R4-code",
        "R4-test"
      ],
      "concurrent_with": [],
      "worktree": "wt/cr-r4-polish-integ",
      "integration_task": null,
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R4-integ.md"
    },
    {
      "id": "R5-code",
      "name": "Shell execution decomposition",
      "type": "code",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Split shell execution stack into modules (routing, invocation planning, platform adapters) and break up pty_exec/settings/manager init without changing CLI behavior.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/shell/src/execution/mod.rs",
        "crates/shell/src/execution/pty_exec.rs",
        "crates/shell/src/execution/settings.rs",
        "crates/shell/src/execution/manager_init.rs"
      ],
      "acceptance_criteria": [
        "execution/mod.rs reduced to a thin public surface with routing/invocation/platform logic moved into submodules; no behavior or CLI flag changes.",
        "pty_exec split into control/data-plane modules with clear traits and channel-based flow preserved; settings/manager initialization separated into focused files.",
        "Tracing/logging, cfg-gates, and redaction remain intact; docs updated for new module layout as needed.",
        "cargo fmt; cargo clippy --workspace --all-targets -- -D warnings; cargo test -p substrate-shell world_root; cargo test -p substrate-shell world_enable all pass."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R5-code to in_progress, log START entry, commit docs update",
        "Create task branch cr-r5-exec-code",
        "Create worktree wt/cr-r5-exec-code from that branch"
      ],
      "end_checklist": [
        "Ensure fmt/clippy/tests per prompt are green and recorded for END log",
        "Commit worktree changes with descriptive message",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry and reference paired test prompt",
        "Commit docs update on feat/crate-refactor"
      ],
      "depends_on": [
        "R4-integ"
      ],
      "concurrent_with": [
        "R5-test"
      ],
      "worktree": "wt/cr-r5-exec-code",
      "integration_task": "R5-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R5-code.md"
    },
    {
      "id": "R5-test",
      "name": "Shell execution decomposition tests",
      "type": "test",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Add/reshape tests for the split shell execution modules and PTY pipeline, ensuring routing, plan building, and resize/write flows remain correct.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/shell/src/execution",
        "crates/shell/tests"
      ],
      "acceptance_criteria": [
        "Tests cover routing/invocation seams of the new execution modules plus PTY control/data-plane interactions (resize/write/close) with channel assertions.",
        "Fixtures updated to mirror module layout; no production code edits beyond test-only helpers.",
        "cargo fmt; cargo test -p substrate-shell world_root; cargo test -p substrate-shell world_enable documented in session log (note platform skips if any).",
        "Kickoff prompt for R5-integ created/referenced."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R5-test to in_progress, log START entry, commit docs update",
        "Create task branch cr-r5-exec-test",
        "Create worktree wt/cr-r5-exec-test from that branch"
      ],
      "end_checklist": [
        "Ensure fmt/tests per prompt are green; capture outputs for END log",
        "Commit worktree changes with descriptive message",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; reference integration prompt",
        "Commit docs update on feat/crate-refactor"
      ],
      "depends_on": [
        "R4-integ"
      ],
      "concurrent_with": [
        "R5-code"
      ],
      "worktree": "wt/cr-r5-exec-test",
      "integration_task": "R5-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R5-test.md"
    },
    {
      "id": "R5-integ",
      "name": "Integrate shell execution decomposition",
      "type": "integration",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Merge shell execution code/test branches, resolve conflicts, and ensure fmt/clippy/tests stay green after the module split.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "crates/shell/src/execution"
      ],
      "acceptance_criteria": [
        "wt/cr-r5-exec-integ merges R5 code+tests with clean fmt/clippy/test runs.",
        "feat/crate-refactor updated with integration results and doc/task/log entries.",
        "Kickoff prompts for R6 tasks captured before finishing."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Confirm R5-code/test completed",
        "Set R5-integ to in_progress, update session_log.md, commit docs update",
        "Create task branch cr-r5-exec-integ",
        "Create worktree wt/cr-r5-exec-integ from that branch"
      ],
      "end_checklist": [
        "Merge code/test branches into integration branch/worktree and resolve conflicts",
        "Run required fmt/clippy/tests",
        "Merge integration branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry",
        "Push or hand off"
      ],
      "depends_on": [
        "R5-code",
        "R5-test"
      ],
      "concurrent_with": [],
      "worktree": "wt/cr-r5-exec-integ",
      "integration_task": null,
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R5-integ.md"
    },
    {
      "id": "R6-code",
      "name": "Bootstrap & builtins decomposition",
      "type": "code",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Split manager_manifest, shim exec, and large shell builtins into focused modules with unchanged outputs and logging.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/common/src/manager_manifest.rs",
        "crates/shim/src/exec.rs",
        "crates/shell/src/builtins/shim_doctor.rs",
        "crates/shell/src/builtins/world_enable.rs",
        "crates/shell/src/builtins/world_deps.rs"
      ],
      "acceptance_criteria": [
        "manager_manifest split into schema/resolver/validator modules with stable manifest semantics and serde behavior.",
        "shim exec split into bootstrap/logging/policy pieces with thin entry surface; builtins decomposed per subcommand with shared helpers.",
        "CLI outputs, logging/redaction, and cfg-gates preserved; docs updated for new module paths where referenced.",
        "cargo fmt; cargo clippy --workspace --all-targets -- -D warnings; cargo test -p substrate-common --all-targets; cargo test -p substrate-shim; cargo test -p substrate-shell world_root/world_enable pass (skips noted)."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R6-code to in_progress, log START entry, commit docs update",
        "Create task branch cr-r6-bootstrap-code",
        "Create worktree wt/cr-r6-bootstrap-code from that branch"
      ],
      "end_checklist": [
        "Ensure fmt/clippy/tests per prompt are green; record outputs for END log",
        "Commit worktree changes with descriptive message",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; reference paired test prompt",
        "Commit docs update on feat/crate-refactor"
      ],
      "depends_on": [
        "R5-integ"
      ],
      "concurrent_with": [
        "R6-test"
      ],
      "worktree": "wt/cr-r6-bootstrap-code",
      "integration_task": "R6-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R6-code.md"
    },
    {
      "id": "R6-test",
      "name": "Bootstrap & builtins tests",
      "type": "test",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Add tests/fixtures for the split manager_manifest, shim exec, and builtin modules, validating outputs and validation paths.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/common/tests",
        "crates/shim/tests",
        "crates/shell/tests"
      ],
      "acceptance_criteria": [
        "Tests cover manifest parsing/expansion/validation per new modules; shim exec bootstrap/logging flows; builtin command behaviors with fixtures matching new layouts.",
        "Fixtures updated without altering production code beyond test-only helpers; logging/redaction expectations asserted where applicable.",
        "cargo fmt; cargo test -p substrate-common --all-targets; cargo test -p substrate-shim; cargo test -p substrate-shell world_root/world_enable (skips noted) logged in session log.",
        "Kickoff prompt for R6-integ produced/referenced."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R6-test to in_progress, log START entry, commit docs update",
        "Create task branch cr-r6-bootstrap-test",
        "Create worktree wt/cr-r6-bootstrap-test from that branch"
      ],
      "end_checklist": [
        "Ensure fmt/tests per prompt are green; capture outputs for END log",
        "Commit worktree changes with descriptive message",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; reference integration prompt",
        "Commit docs update on feat/crate-refactor"
      ],
      "depends_on": [
        "R5-integ"
      ],
      "concurrent_with": [
        "R6-code"
      ],
      "worktree": "wt/cr-r6-bootstrap-test",
      "integration_task": "R6-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R6-test.md"
    },
    {
      "id": "R6-integ",
      "name": "Integrate bootstrap & builtins decomposition",
      "type": "integration",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Merge manager_manifest/shim/builtins code/test branches, resolve conflicts, and ensure fmt/clippy/tests are green.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "crates/common",
        "crates/shim",
        "crates/shell/src/builtins"
      ],
      "acceptance_criteria": [
        "wt/cr-r6-bootstrap-integ merges R6 code+tests with clean fmt/clippy/test runs across common/shim/shell builtins.",
        "feat/crate-refactor updated with integration results and doc/task/log entries committed.",
        "Kickoff prompts for R7 tasks captured before ending session."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Confirm R6-code/test completed",
        "Set R6-integ to in_progress, update session_log.md, commit docs update",
        "Create task branch cr-r6-bootstrap-integ",
        "Create worktree wt/cr-r6-bootstrap-integ from that branch"
      ],
      "end_checklist": [
        "Merge code/test branches into integration branch/worktree and resolve conflicts",
        "Run required fmt/clippy/tests",
        "Merge integration branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry",
        "Push or hand off"
      ],
      "depends_on": [
        "R6-code",
        "R6-test"
      ],
      "concurrent_with": [],
      "worktree": "wt/cr-r6-bootstrap-integ",
      "integration_task": null,
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R6-integ.md"
    },
    {
      "id": "R7-code",
      "name": "Service module slimming",
      "type": "code",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Reduce host-proxy/lib.rs, world/overlayfs.rs, and replay/replay.rs into thin public surfaces with internal modules, keeping behavior and performance stable.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/host-proxy/src/lib.rs",
        "crates/world/src/overlayfs.rs",
        "crates/replay/src/replay.rs"
      ],
      "acceptance_criteria": [
        "host-proxy/lib.rs split into library surface plus modules for config, transport, and runtime; thin binary pattern maintained.",
        "world overlayfs logic separated into layering/utils modules with unchanged behavior and platform guards.",
        "replay/replay.rs decomposed into planners/executors/helpers with same CLI/API semantics; docs updated if paths referenced.",
        "cargo fmt; cargo clippy --workspace --all-targets -- -D warnings; cargo test -p host-proxy; cargo test -p world; cargo test -p substrate-replay --all-targets pass (note skips)."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R7-code to in_progress, log START entry, commit docs update",
        "Create task branch cr-r7-services-code",
        "Create worktree wt/cr-r7-services-code from that branch"
      ],
      "end_checklist": [
        "Ensure fmt/clippy/tests per prompt are green; capture outputs for END log",
        "Commit worktree changes with descriptive message",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; reference paired test prompt",
        "Commit docs update on feat/crate-refactor"
      ],
      "depends_on": [
        "R6-integ"
      ],
      "concurrent_with": [
        "R7-test"
      ],
      "worktree": "wt/cr-r7-services-code",
      "integration_task": "R7-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R7-code.md"
    },
    {
      "id": "R7-test",
      "name": "Service module tests",
      "type": "test",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Add tests/fixtures for slimmed host-proxy/overlayfs/replay modules, confirming semantics and performance-sensitive paths remain stable.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/host-proxy/tests",
        "crates/world/tests",
        "crates/replay/tests"
      ],
      "acceptance_criteria": [
        "Tests cover host-proxy config/transport/runtime seams; overlayfs layering behavior; replay planner/executor equivalence including property cases where appropriate.",
        "Fixtures reflect new module layout; no production code edits beyond test-only helpers; note any platform skips.",
        "cargo fmt; cargo test -p host-proxy; cargo test -p world; cargo test -p substrate-replay --all-targets documented in session log.",
        "Kickoff prompt for R7-integ produced/referenced."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R7-test to in_progress, log START entry, commit docs update",
        "Create task branch cr-r7-services-test",
        "Create worktree wt/cr-r7-services-test from that branch"
      ],
      "end_checklist": [
        "Ensure fmt/tests per prompt are green; capture outputs for END log",
        "Commit worktree changes with descriptive message",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; reference integration prompt",
        "Commit docs update on feat/crate-refactor"
      ],
      "depends_on": [
        "R6-integ"
      ],
      "concurrent_with": [
        "R7-code"
      ],
      "worktree": "wt/cr-r7-services-test",
      "integration_task": "R7-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R7-test.md"
    },
    {
      "id": "R7-integ",
      "name": "Integrate service module slimming",
      "type": "integration",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Merge host-proxy/overlayfs/replay code/test branches, resolve conflicts, and ensure fmt/clippy/tests are green.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "crates/host-proxy",
        "crates/world/src/overlayfs.rs",
        "crates/replay/src/replay.rs"
      ],
      "acceptance_criteria": [
        "wt/cr-r7-services-integ merges R7 code+tests with clean fmt/clippy/test runs.",
        "feat/crate-refactor updated with integration results and doc/task/log entries.",
        "Follow-up prompts/notes captured before ending session."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Confirm R7-code/test completed",
        "Set R7-integ to in_progress, update session_log.md, commit docs update",
        "Create task branch cr-r7-services-integ",
        "Create worktree wt/cr-r7-services-integ from that branch"
      ],
      "end_checklist": [
        "Merge code/test branches into integration branch/worktree and resolve conflicts",
        "Run required fmt/clippy/tests",
        "Merge integration branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry",
        "Push or hand off"
      ],
      "depends_on": [
        "R7-code",
        "R7-test"
      ],
      "concurrent_with": [],
      "worktree": "wt/cr-r7-services-integ",
      "integration_task": null,
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R7-integ.md"
    },
    {
      "id": "R8-code",
      "name": "Shell execution file slicing",
      "type": "code",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Further decompose oversized shell execution files (routing.rs, pty/io.rs, invocation.rs, settings.rs, platform.rs, manager_init.rs) into focused modules while keeping behavior stable.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/shell/src/execution/routing.rs",
        "crates/shell/src/execution/pty/io.rs",
        "crates/shell/src/execution/invocation.rs",
        "crates/shell/src/execution/settings.rs",
        "crates/shell/src/execution/platform.rs",
        "crates/shell/src/execution/manager_init.rs"
      ],
      "acceptance_criteria": [
        "Each target file is split into domain-specific modules (e.g., routing split into dispatch/path/cwd/env helpers; io traits/state vs sinks/sources; invocation planning vs env/cwd prep; settings/builders; platform adapters; manager initialization) with a thin public surface.",
        "No CLI/config behavior changes; tracing/logging, redaction, and cfg-gates remain intact, and the PTY/channel flow stays unchanged.",
        "New modules documented with brief rustdoc headers; public APIs remain stable or are re-exported to preserve call sites.",
        "cargo fmt; cargo clippy --workspace --all-targets -- -D warnings; cargo test -p substrate-shell world_root; cargo test -p substrate-shell world_enable pass (skips noted in logs)."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R8-code to in_progress, update session_log.md with START entry, commit docs update (`git commit -am \"docs: start R8-code\"`)",
        "Create task branch cr-r8-shell-slim-code",
        "Create worktree wt/cr-r8-shell-slim-code from that branch"
      ],
      "end_checklist": [
        "Ensure fmt/lint/tests per prompt are green; capture outputs for END log entry",
        "Commit worktree changes with descriptive message",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; reference paired test prompt",
        "Commit docs update on feat/crate-refactor (`git commit -am \"docs: finish R8-code\"`)"
      ],
      "depends_on": [
        "R7-integ"
      ],
      "concurrent_with": [
        "R8-test"
      ],
      "worktree": "wt/cr-r8-shell-slim-code",
      "integration_task": "R8-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R8-code.md"
    },
    {
      "id": "R8-test",
      "name": "Shell execution slicing tests",
      "type": "test",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Add/reshape tests to cover the new shell execution submodules (pty/io, invocation planning, settings, platform adapters, manager init) without altering production code.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/shell/tests",
        "crates/shell/src/execution"
      ],
      "acceptance_criteria": [
        "Tests/fixtures mirror the new module layout and cover PTY IO traits (resize/write/close), invocation plan building (env/path/cwd), settings resolution, platform adapter selection, and manager initialization flows.",
        "No production code edits beyond test-only helpers; existing fixtures updated for module moves.",
        "cargo fmt; cargo test -p substrate-shell world_root; cargo test -p substrate-shell world_enable (document skips) logged in session log.",
        "Paired integration prompt created/referenced; END log includes commands/results."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R8-test to in_progress, update session_log.md with START entry, commit docs update (`git commit -am \"docs: start R8-test\"`)",
        "Create task branch cr-r8-shell-slim-test",
        "Create worktree wt/cr-r8-shell-slim-test from that branch"
      ],
      "end_checklist": [
        "Ensure required tests are green; capture outputs for END log",
        "Commit worktree changes with descriptive message",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; reference integration prompt",
        "Commit docs update on feat/crate-refactor (`git commit -am \"docs: finish R8-test\"`)"
      ],
      "depends_on": [
        "R7-integ"
      ],
      "concurrent_with": [
        "R8-code"
      ],
      "worktree": "wt/cr-r8-shell-slim-test",
      "integration_task": "R8-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R8-test.md"
    },
    {
      "id": "R8-integ",
      "name": "Integrate shell execution slicing",
      "type": "integration",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Merge R8 code/test worktrees for the shell execution slicing, resolve conflicts, and ensure fmt/clippy/tests stay green after the splits.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "crates/shell/src/execution",
        "crates/shell/tests"
      ],
      "acceptance_criteria": [
        "wt/cr-r8-shell-slim-integ merges R8 code/test branches with clean fmt/clippy/test runs for substrate-shell (world_root/world_enable).",
        "feat/crate-refactor updated with integration results and doc/task/log entries.",
        "Follow-up kickoff prompts/notes captured before closing the session."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Confirm R8-code/test completed",
        "Set R8-integ to in_progress, update session_log.md with START entry, commit docs update (`git commit -am \"docs: start R8-integ\"`)",
        "Create task branch cr-r8-shell-slim-integ",
        "Create worktree wt/cr-r8-shell-slim-integ from that branch"
      ],
      "end_checklist": [
        "Merge code/test branches into integration branch/worktree and resolve conflicts",
        "Run required fmt/clippy/tests noted in prompts",
        "Merge integration branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; push or hand off"
      ],
      "depends_on": [
        "R8-code",
        "R8-test"
      ],
      "concurrent_with": [],
      "worktree": "wt/cr-r8-shell-slim-integ",
      "integration_task": null,
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R8-integ.md"
    },
    {
      "id": "R9a-code",
      "name": "Routing split: dispatch & builtins",
      "type": "code",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Split routing.rs by dispatch/builtin handling, keeping CLI semantics and logging unchanged; introduce focused modules and re-export a thin surface.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/shell/src/execution/routing.rs"
      ],
      "acceptance_criteria": [
        "routing dispatch/builtin logic extracted into dedicated modules (e.g., dispatch.rs, builtins.rs) with a thin public surface and stable call sites via re-exports.",
        "Path/cwd/env helpers untouched in this wave; no CLI/config behavior changes; tracing/redaction/cfg gates preserved.",
        "rustdoc headers describe module roles; public API remains stable.",
        "cargo fmt; cargo clippy --workspace --all-targets -- -D warnings; cargo test -p substrate-shell world_root; cargo test -p substrate-shell world_enable pass (skips noted)."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R9a-code to in_progress, update session_log.md with START entry, commit docs update (`git commit -am \"docs: start R9a-code\"`)",
        "Create task branch cr-r9a-routing-code",
        "Create worktree wt/cr-r9a-routing-code from that branch"
      ],
      "end_checklist": [
        "Ensure fmt/lint/tests per prompt are green; capture outputs for END log entry",
        "Commit worktree changes with descriptive message",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; reference paired test prompt",
        "Commit docs update on feat/crate-refactor (`git commit -am \"docs: finish R9a-code\"`)"
      ],
      "depends_on": [
        "R8-integ"
      ],
      "concurrent_with": [
        "R9a-test"
      ],
      "worktree": "wt/cr-r9a-routing-code",
      "integration_task": "R9a-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R9a-code.md"
    },
    {
      "id": "R9a-test",
      "name": "Routing split tests: dispatch & builtins",
      "type": "test",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Align tests/fixtures with the routing dispatch/builtin module split; cover dispatch paths without changing production code.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/shell/tests",
        "crates/shell/src/execution/routing.rs"
      ],
      "acceptance_criteria": [
        "Tests updated to new module paths; coverage for dispatch/builtin routing preserved (world enable/disable flows, builtin selection).",
        "No production code changes beyond test-only helpers; logging/redaction expectations maintained.",
        "cargo fmt; cargo test -p substrate-shell world_root; cargo test -p substrate-shell world_enable (skips noted) logged in session log.",
        "Integration prompt referenced in END log."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R9a-test to in_progress, update session_log.md with START entry, commit docs update (`git commit -am \"docs: start R9a-test\"`)",
        "Create task branch cr-r9a-routing-test",
        "Create worktree wt/cr-r9a-routing-test from that branch"
      ],
      "end_checklist": [
        "Ensure required tests are green; capture outputs for END log",
        "Commit worktree changes with descriptive message",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; reference integration prompt",
        "Commit docs update on feat/crate-refactor (`git commit -am \"docs: finish R9a-test\"`)"
      ],
      "depends_on": [
        "R8-integ"
      ],
      "concurrent_with": [
        "R9a-code"
      ],
      "worktree": "wt/cr-r9a-routing-test",
      "integration_task": "R9a-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R9a-test.md"
    },
    {
      "id": "R9a-integ",
      "name": "Integrate routing split: dispatch & builtins",
      "type": "integration",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Merge R9a code/test routing split for dispatch/builtins, resolve conflicts, ensure fmt/clippy/tests are green.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "crates/shell/src/execution/routing.rs",
        "crates/shell/tests"
      ],
      "acceptance_criteria": [
        "wt/cr-r9a-routing-integ merges R9a code+tests with clean fmt/clippy/test runs for substrate-shell (world_root/world_enable).",
        "feat/crate-refactor updated with integration results and doc/task/log entries.",
        "Follow-up prompts/notes captured before closing the session."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Confirm R9a-code/test completed",
        "Set R9a-integ to in_progress, update session_log.md with START entry, commit docs update (`git commit -am \"docs: start R9a-integ\"`)",
        "Create task branch cr-r9a-routing-integ",
        "Create worktree wt/cr-r9a-routing-integ from that branch"
      ],
      "end_checklist": [
        "Merge code/test branches into integration branch/worktree and resolve conflicts",
        "Run required fmt/clippy/tests noted in prompts",
        "Merge integration branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; push or hand off"
      ],
      "depends_on": [
        "R9a-code",
        "R9a-test"
      ],
      "concurrent_with": [],
      "worktree": "wt/cr-r9a-routing-integ",
      "integration_task": null,
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R9a-integ.md"
    },
    {
      "id": "R9b-code",
      "name": "Routing split: path/env/cwd helpers",
      "type": "code",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Extract path/cwd/env/world-env helpers from routing.rs into focused modules; keep behavior and logging unchanged.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/shell/src/execution/routing.rs"
      ],
      "acceptance_criteria": [
        "Path/cwd/env/world-env helpers moved to dedicated modules with a thin re-exported surface; routing.rs shrinks accordingly.",
        "No behavior changes for path resolution, cwd handling, or env munging; tracing/redaction and cfg gates preserved.",
        "rustdoc headers on new modules; public API preserved via re-exports.",
        "cargo fmt; cargo clippy --workspace --all-targets -- -D warnings; cargo test -p substrate-shell world_root; cargo test -p substrate-shell world_enable pass (skips noted)."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R9b-code to in_progress, update session_log.md with START entry, commit docs update (`git commit -am \"docs: start R9b-code\"`)",
        "Create task branch cr-r9b-routing-code",
        "Create worktree wt/cr-r9b-routing-code from that branch"
      ],
      "end_checklist": [
        "Ensure fmt/lint/tests per prompt are green; capture outputs for END log entry",
        "Commit worktree changes with descriptive message",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; reference paired test prompt",
        "Commit docs update on feat/crate-refactor (`git commit -am \"docs: finish R9b-code\"`)"
      ],
      "depends_on": [
        "R9a-integ"
      ],
      "concurrent_with": [
        "R9b-test"
      ],
      "worktree": "wt/cr-r9b-routing-code",
      "integration_task": "R9b-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R9b-code.md"
    },
    {
      "id": "R9b-test",
      "name": "Routing split tests: path/env/cwd helpers",
      "type": "test",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Update tests/fixtures for routing path/cwd/env helper extraction; keep assertions intact.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/shell/tests",
        "crates/shell/src/execution/routing.rs"
      ],
      "acceptance_criteria": [
        "Tests target new helper modules (path normalization, cwd transitions, env filtering) with behavior preserved.",
        "No production code changes beyond test-only helpers; platform-gated cases and redaction expectations intact.",
        "cargo fmt; cargo test -p substrate-shell world_root; cargo test -p substrate-shell world_enable (skips noted) logged in session log.",
        "Integration prompt referenced in END log."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R9b-test to in_progress, update session_log.md with START entry, commit docs update (`git commit -am \"docs: start R9b-test\"`)",
        "Create task branch cr-r9b-routing-test",
        "Create worktree wt/cr-r9b-routing-test from that branch"
      ],
      "end_checklist": [
        "Ensure required tests are green; capture outputs for END log",
        "Commit worktree changes with descriptive message",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; reference integration prompt",
        "Commit docs update on feat/crate-refactor (`git commit -am \"docs: finish R9b-test\"`)"
      ],
      "depends_on": [
        "R9a-integ"
      ],
      "concurrent_with": [
        "R9b-code"
      ],
      "worktree": "wt/cr-r9b-routing-test",
      "integration_task": "R9b-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R9b-test.md"
    },
    {
      "id": "R9b-integ",
      "name": "Integrate routing split: path/env/cwd helpers",
      "type": "integration",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Merge R9b code/test routing split for path/cwd/env helpers, resolve conflicts, ensure fmt/clippy/tests are green.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "crates/shell/src/execution/routing.rs",
        "crates/shell/tests"
      ],
      "acceptance_criteria": [
        "wt/cr-r9b-routing-integ merges R9b code+tests with clean fmt/clippy/test runs for substrate-shell (world_root/world_enable).",
        "feat/crate-refactor updated with integration results and doc/task/log entries.",
        "Follow-up prompts/notes captured before closing the session."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Confirm R9b-code/test completed",
        "Set R9b-integ to in_progress, update session_log.md with START entry, commit docs update (`git commit -am \"docs: start R9b-integ\"`)",
        "Create task branch cr-r9b-routing-integ",
        "Create worktree wt/cr-r9b-routing-integ from that branch"
      ],
      "end_checklist": [
        "Merge code/test branches into integration branch/worktree and resolve conflicts",
        "Run required fmt/clippy/tests noted in prompts",
        "Merge integration branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; push or hand off"
      ],
      "depends_on": [
        "R9b-code",
        "R9b-test"
      ],
      "concurrent_with": [],
      "worktree": "wt/cr-r9b-routing-integ",
      "integration_task": null,
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R9b-integ.md"
    },
    {
      "id": "R9c-code",
      "name": "Routing split: world/agent flows",
      "type": "code",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Extract world enable/disable, agent client wiring, and platform bridging logic from routing.rs into focused modules; preserve CLI behavior.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/shell/src/execution/routing.rs"
      ],
      "acceptance_criteria": [
        "World toggle, agent client setup, and platform-bridge helpers moved to dedicated modules with thin re-exported surfaces.",
        "Behavior unchanged for world enable/disable flows and agent invocation; tracing/redaction/cfg gates preserved.",
        "rustdoc headers on new modules; public API preserved via re-exports.",
        "cargo fmt; cargo clippy --workspace --all-targets -- -D warnings; cargo test -p substrate-shell world_root; cargo test -p substrate-shell world_enable pass (skips noted)."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R9c-code to in_progress, update session_log.md with START entry, commit docs update (`git commit -am \"docs: start R9c-code\"`)",
        "Create task branch cr-r9c-routing-code",
        "Create worktree wt/cr-r9c-routing-code from that branch"
      ],
      "end_checklist": [
        "Ensure fmt/lint/tests per prompt are green; capture outputs for END log entry",
        "Commit worktree changes with descriptive message",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; reference paired test prompt",
        "Commit docs update on feat/crate-refactor (`git commit -am \"docs: finish R9c-code\"`)"
      ],
      "depends_on": [
        "R9b-integ"
      ],
      "concurrent_with": [
        "R9c-test"
      ],
      "worktree": "wt/cr-r9c-routing-code",
      "integration_task": "R9c-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R9c-code.md"
    },
    {
      "id": "R9c-test",
      "name": "Routing split tests: world/agent flows",
      "type": "test",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Update tests/fixtures for world enable/disable and agent client flows after routing split; preserve behavior assertions.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/shell/tests",
        "crates/shell/src/execution/routing.rs"
      ],
      "acceptance_criteria": [
        "Tests cover world toggle/agent client routes with new module paths; behavior unchanged.",
        "No production code changes beyond test-only helpers; platform skips documented.",
        "cargo fmt; cargo test -p substrate-shell world_root; cargo test -p substrate-shell world_enable (skips noted) logged in session log.",
        "Integration prompt referenced in END log."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R9c-test to in_progress, update session_log.md with START entry, commit docs update (`git commit -am \"docs: start R9c-test\"`)",
        "Create task branch cr-r9c-routing-test",
        "Create worktree wt/cr-r9c-routing-test from that branch"
      ],
      "end_checklist": [
        "Ensure required tests are green; capture outputs for END log",
        "Commit worktree changes with descriptive message",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; reference integration prompt",
        "Commit docs update on feat/crate-refactor (`git commit -am \"docs: finish R9c-test\"`)"
      ],
      "depends_on": [
        "R9b-integ"
      ],
      "concurrent_with": [
        "R9c-code"
      ],
      "worktree": "wt/cr-r9c-routing-test",
      "integration_task": "R9c-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R9c-test.md"
    },
    {
      "id": "R9c-integ",
      "name": "Integrate routing split: world/agent flows",
      "type": "integration",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Merge R9c code/test routing split for world/agent flows, resolve conflicts, ensure fmt/clippy/tests are green.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "crates/shell/src/execution/routing.rs",
        "crates/shell/tests"
      ],
      "acceptance_criteria": [
        "wt/cr-r9c-routing-integ merges R9c code+tests with clean fmt/clippy/test runs for substrate-shell (world_root/world_enable).",
        "feat/crate-refactor updated with integration results and doc/task/log entries.",
        "Follow-up prompts/notes captured before closing the session."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Confirm R9c-code/test completed",
        "Set R9c-integ to in_progress, update session_log.md with START entry, commit docs update (`git commit -am \"docs: start R9c-integ\"`)",
        "Create task branch cr-r9c-routing-integ",
        "Create worktree wt/cr-r9c-routing-integ from that branch"
      ],
      "end_checklist": [
        "Merge code/test branches into integration branch/worktree and resolve conflicts",
        "Run required fmt/clippy/tests noted in prompts",
        "Merge integration branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; push or hand off"
      ],
      "depends_on": [
        "R9c-code",
        "R9c-test"
      ],
      "concurrent_with": [],
      "worktree": "wt/cr-r9c-routing-integ",
      "integration_task": null,
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R9c-integ.md"
    },
    {
      "id": "R10-code",
      "name": "PTY IO module slicing",
      "type": "code",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Split execution/pty/io/mod.rs into focused modules (traits/state vs readers/writers) while preserving channel semantics and logging.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/shell/src/execution/pty/io/mod.rs"
      ],
      "acceptance_criteria": [
        "pty/io/mod.rs decomposed into small modules (types/traits, reader path, writer path, tests) with re-exports to keep API stable.",
        "Channel/resize/write/close behavior unchanged; tracing/redaction and platform gates preserved.",
        "rustdoc headers added to new modules; public API preserved via re-exports.",
        "cargo fmt; cargo clippy --workspace --all-targets -- -D warnings; cargo test -p substrate-shell world_root; cargo test -p substrate-shell world_enable pass (skips noted)."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R10-code to in_progress, update session_log.md with START entry, commit docs update (`git commit -am \"docs: start R10-code\"`)",
        "Create task branch cr-r10-pty-code",
        "Create worktree wt/cr-r10-pty-code from that branch"
      ],
      "end_checklist": [
        "Ensure fmt/lint/tests per prompt are green; capture outputs for END log entry",
        "Commit worktree changes with descriptive message",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; reference paired test prompt",
        "Commit docs update on feat/crate-refactor (`git commit -am \"docs: finish R10-code\"`)"
      ],
      "depends_on": [
        "R9c-integ"
      ],
      "concurrent_with": [
        "R10-test"
      ],
      "worktree": "wt/cr-r10-pty-code",
      "integration_task": "R10-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R10-code.md"
    },
    {
      "id": "R10-test",
      "name": "PTY IO module tests",
      "type": "test",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Update/add tests to mirror the pty/io module split; assert resize/write/close/channel flows remain correct.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/shell/tests",
        "crates/shell/src/execution/pty/io/mod.rs"
      ],
      "acceptance_criteria": [
        "Tests/fixtures updated to new pty/io module layout; behavior (resize/write/close) assertions intact.",
        "No production code changes beyond test-only helpers; platform skips documented.",
        "cargo fmt; cargo test -p substrate-shell world_root; cargo test -p substrate-shell world_enable (skips noted) logged in session log.",
        "Integration prompt referenced in END log."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R10-test to in_progress, update session_log.md with START entry, commit docs update (`git commit -am \"docs: start R10-test\"`)",
        "Create task branch cr-r10-pty-test",
        "Create worktree wt/cr-r10-pty-test from that branch"
      ],
      "end_checklist": [
        "Ensure required tests are green; capture outputs for END log",
        "Commit worktree changes with descriptive message",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; reference integration prompt",
        "Commit docs update on feat/crate-refactor (`git commit -am \"docs: finish R10-test\"`)"
      ],
      "depends_on": [
        "R9c-integ"
      ],
      "concurrent_with": [
        "R10-code"
      ],
      "worktree": "wt/cr-r10-pty-test",
      "integration_task": "R10-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R10-test.md"
    },
    {
      "id": "R10-integ",
      "name": "Integrate PTY IO module slicing",
      "type": "integration",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Merge R10 code/test pty/io splits, resolve conflicts, ensure fmt/clippy/tests are green.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "crates/shell/src/execution/pty/io/mod.rs",
        "crates/shell/tests"
      ],
      "acceptance_criteria": [
        "wt/cr-r10-pty-integ merges R10 code+tests with clean fmt/clippy/test runs for substrate-shell (world_root/world_enable).",
        "feat/crate-refactor updated with integration results and doc/task/log entries.",
        "Follow-up prompts/notes captured before closing the session."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Confirm R10-code/test completed",
        "Set R10-integ to in_progress, update session_log.md with START entry, commit docs update (`git commit -am \"docs: start R10-integ\"`)",
        "Create task branch cr-r10-pty-integ",
        "Create worktree wt/cr-r10-pty-integ from that branch"
      ],
      "end_checklist": [
        "Merge code/test branches into integration branch/worktree and resolve conflicts",
        "Run required fmt/clippy/tests noted in prompts",
        "Merge integration branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; push or hand off"
      ],
      "depends_on": [
        "R10-code",
        "R10-test"
      ],
      "concurrent_with": [],
      "worktree": "wt/cr-r10-pty-integ",
      "integration_task": null,
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R10-integ.md"
    },
    {
      "id": "R11-code",
      "name": "Routing dispatch modularization",
      "type": "code",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Break routing/dispatch.rs into focused modules and a registry-style router to shrink the remaining god file without changing CLI behavior.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/shell/src/execution/routing/dispatch.rs"
      ],
      "acceptance_criteria": [
        "dispatch.rs split into domain modules (e.g., command registry, workspace/world ops, shim/install ops, exec/launch) with a thin router surface and re-exports for compatibility.",
        "CLI/config behavior unchanged; tracing/logging/redaction and cfg gates preserved.",
        "rustdoc headers on new modules; public API preserved via re-exports or adapter functions.",
        "cargo fmt; cargo clippy --workspace --all-targets -- -D warnings; cargo test -p substrate-shell world_root; cargo test -p substrate-shell world_enable pass (skips noted)."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R11-code to in_progress, update session_log.md with START entry, commit docs update (`git commit -am \"docs: start R11-code\"`)",
        "Create task branch cr-r11-routing-code",
        "Create worktree wt/cr-r11-routing-code from that branch"
      ],
      "end_checklist": [
        "Ensure fmt/lint/tests per prompt are green; capture outputs for END log entry",
        "Commit worktree changes with descriptive message",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; reference paired test prompt",
        "Commit docs update on feat/crate-refactor (`git commit -am \"docs: finish R11-code\"`)"
      ],
      "depends_on": [
        "R10-integ"
      ],
      "concurrent_with": [
        "R11-test"
      ],
      "worktree": "wt/cr-r11-routing-code",
      "integration_task": "R11-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R11-code.md"
    },
    {
      "id": "R11-test",
      "name": "Routing dispatch modularization tests",
      "type": "test",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Update/move tests to match the dispatch modularization and ensure routing behavior stays intact.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/shell/tests",
        "crates/shell/src/execution/routing/dispatch.rs"
      ],
      "acceptance_criteria": [
        "Tests cover the new dispatch modules/registry without behavior changes (world enable/disable, builtins, exec paths).",
        "No production code changes beyond test-only helpers; logging/redaction expectations maintained.",
        "cargo fmt; cargo test -p substrate-shell world_root; cargo test -p substrate-shell world_enable (skips noted) logged in session log.",
        "Integration prompt referenced in END log."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R11-test to in_progress, update session_log.md with START entry, commit docs update (`git commit -am \"docs: start R11-test\"`)",
        "Create task branch cr-r11-routing-test",
        "Create worktree wt/cr-r11-routing-test from that branch"
      ],
      "end_checklist": [
        "Ensure required tests are green; capture outputs for END log",
        "Commit worktree changes with descriptive message",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; reference integration prompt",
        "Commit docs update on feat/crate-refactor (`git commit -am \"docs: finish R11-test\"`)"
      ],
      "depends_on": [
        "R10-integ"
      ],
      "concurrent_with": [
        "R11-code"
      ],
      "worktree": "wt/cr-r11-routing-test",
      "integration_task": "R11-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R11-test.md"
    },
    {
      "id": "R11-integ",
      "name": "Integrate routing dispatch modularization",
      "type": "integration",
      "phase": "Crate Refactor",
      "status": "completed",
      "description": "Merge R11 code/test routing modularization, resolve conflicts, ensure fmt/clippy/tests are green.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "crates/shell/src/execution/routing/dispatch.rs",
        "crates/shell/tests"
      ],
      "acceptance_criteria": [
        "wt/cr-r11-routing-integ merges R11 code+tests with clean fmt/clippy/test runs for substrate-shell (world_root/world_enable).",
        "feat/crate-refactor updated with integration results and doc/task/log entries.",
        "Follow-up prompts/notes captured before closing the session."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Confirm R11-code/test completed",
        "Set R11-integ to in_progress, update session_log.md with START entry, commit docs update (`git commit -am \"docs: start R11-integ\"`)",
        "Create task branch cr-r11-routing-integ",
        "Create worktree wt/cr-r11-routing-integ from that branch"
      ],
      "end_checklist": [
        "Merge code/test branches into integration branch/worktree and resolve conflicts",
        "Run required fmt/clippy/tests noted in prompts",
        "Merge integration branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; push or hand off"
      ],
      "depends_on": [
        "R11-code",
        "R11-test"
      ],
      "concurrent_with": [],
      "worktree": "wt/cr-r11-routing-integ",
      "integration_task": null,
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R11-integ.md"
    },
    {
      "id": "R12-code",
      "name": "Routing builtin/world runner slimming",
      "type": "code",
      "phase": "Crate Refactor",
      "status": "pending",
      "description": "Reduce routing builtin modules and world_enable runner into smaller units, keeping outputs and logging stable.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/shell/src/execution/routing/builtin.rs",
        "crates/shell/src/builtins/world_enable/runner.rs"
      ],
      "acceptance_criteria": [
        "builtin.rs split into category modules (world/deps, shim actions, utility) with thin re-exports; world_enable runner split into helpers without behavior changes.",
        "CLI outputs/logging/redaction unchanged; cfg gates preserved.",
        "rustdoc headers on new modules; public API preserved via re-exports.",
        "cargo fmt; cargo clippy --workspace --all-targets -- -D warnings; cargo test -p substrate-shell world_root; cargo test -p substrate-shell world_enable pass (skips noted)."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R12-code to in_progress, update session_log.md with START entry, commit docs update (`git commit -am \"docs: start R12-code\"`)",
        "Create task branch cr-r12-routing-builtin-code",
        "Create worktree wt/cr-r12-routing-builtin-code from that branch"
      ],
      "end_checklist": [
        "Ensure fmt/lint/tests per prompt are green; capture outputs for END log entry",
        "Commit worktree changes with descriptive message",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; reference paired test prompt",
        "Commit docs update on feat/crate-refactor (`git commit -am \"docs: finish R12-code\"`)"
      ],
      "depends_on": [
        "R11-integ"
      ],
      "concurrent_with": [
        "R12-test"
      ],
      "worktree": "wt/cr-r12-routing-builtin-code",
      "integration_task": "R12-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R12-code.md"
    },
    {
      "id": "R12-test",
      "name": "Routing builtin/world runner tests",
      "type": "test",
      "phase": "Crate Refactor",
      "status": "pending",
      "description": "Update/move tests to match builtin/world runner splits; ensure behavior and outputs remain stable.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/shell/tests",
        "crates/shell/src/execution/routing/builtin.rs",
        "crates/shell/src/builtins/world_enable/runner.rs"
      ],
      "acceptance_criteria": [
        "Tests/fixtures updated to new module paths; assertions on builtin dispatch and world runner outputs remain intact.",
        "No production code changes beyond test-only helpers; logging/redaction and platform skips documented.",
        "cargo fmt; cargo test -p substrate-shell world_root; cargo test -p substrate-shell world_enable (skips noted) logged in session log.",
        "Integration prompt referenced in END log."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R12-test to in_progress, update session_log.md with START entry, commit docs update (`git commit -am \"docs: start R12-test\"`)",
        "Create task branch cr-r12-routing-builtin-test",
        "Create worktree wt/cr-r12-routing-builtin-test from that branch"
      ],
      "end_checklist": [
        "Ensure required tests are green; capture outputs for END log",
        "Commit worktree changes with descriptive message",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; reference integration prompt",
        "Commit docs update on feat/crate-refactor (`git commit -am \"docs: finish R12-test\"`)"
      ],
      "depends_on": [
        "R11-integ"
      ],
      "concurrent_with": [
        "R12-code"
      ],
      "worktree": "wt/cr-r12-routing-builtin-test",
      "integration_task": "R12-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R12-test.md"
    },
    {
      "id": "R12-integ",
      "name": "Integrate routing builtin/world runner slimming",
      "type": "integration",
      "phase": "Crate Refactor",
      "status": "pending",
      "description": "Merge R12 code/test splits for routing builtins and world runner, resolve conflicts, ensure fmt/clippy/tests are green.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "crates/shell/src/execution/routing/builtin.rs",
        "crates/shell/src/builtins/world_enable/runner.rs",
        "crates/shell/tests"
      ],
      "acceptance_criteria": [
        "wt/cr-r12-routing-builtin-integ merges R12 code+tests with clean fmt/clippy/test runs for substrate-shell (world_root/world_enable).",
        "feat/crate-refactor updated with integration results and doc/task/log entries.",
        "Follow-up prompts/notes captured before closing the session."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Confirm R12-code/test completed",
        "Set R12-integ to in_progress, update session_log.md with START entry, commit docs update (`git commit -am \"docs: start R12-integ\"`)",
        "Create task branch cr-r12-routing-builtin-integ",
        "Create worktree wt/cr-r12-routing-builtin-integ from that branch"
      ],
      "end_checklist": [
        "Merge code/test branches into integration branch/worktree and resolve conflicts",
        "Run required fmt/clippy/tests noted in prompts",
        "Merge integration branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; push or hand off"
      ],
      "depends_on": [
        "R12-code",
        "R12-test"
      ],
      "concurrent_with": [],
      "worktree": "wt/cr-r12-routing-builtin-integ",
      "integration_task": null,
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R12-integ.md"
    },
    {
      "id": "R13-code",
      "name": "Broker/lib slimming & cleanup",
      "type": "code",
      "phase": "Crate Refactor",
      "status": "pending",
      "description": "Shrink broker/src/lib.rs by extracting modules for profile detection, policy loading, and watch plumbing; keep public API and behavior stable.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/broker/src/lib.rs"
      ],
      "acceptance_criteria": [
        "broker/lib.rs split into focused modules (profiles/watch/loaders/api) with thin re-exported surface; behavior and logging unchanged.",
        "Public API preserved; rustdoc headers on new modules; tracing/redaction intact.",
        "cargo fmt; cargo clippy --workspace --all-targets -- -D warnings; cargo test -p broker pass (skips noted)."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R13-code to in_progress, update session_log.md with START entry, commit docs update (`git commit -am \"docs: start R13-code\"`)",
        "Create task branch cr-r13-broker-code",
        "Create worktree wt/cr-r13-broker-code from that branch"
      ],
      "end_checklist": [
        "Ensure fmt/lint/tests per prompt are green; capture outputs for END log entry",
        "Commit worktree changes with descriptive message",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; reference paired test prompt",
        "Commit docs update on feat/crate-refactor (`git commit -am \"docs: finish R13-code\"`)"
      ],
      "depends_on": [
        "R12-integ"
      ],
      "concurrent_with": [
        "R13-test"
      ],
      "worktree": "wt/cr-r13-broker-code",
      "integration_task": "R13-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R13-code.md"
    },
    {
      "id": "R13-test",
      "name": "Broker/lib slimming tests",
      "type": "test",
      "phase": "Crate Refactor",
      "status": "pending",
      "description": "Update tests/fixtures to match broker/lib.rs split; ensure policy/profile/watch behavior remains intact.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "docs/project_management/analysis/CRATE_REFACTORING_ANALYSIS.md",
        "crates/broker/tests",
        "crates/broker/src/lib.rs"
      ],
      "acceptance_criteria": [
        "Tests reflect new module layout (profiles/watch/loaders) with unchanged behavior and logging expectations.",
        "No production code changes beyond test-only helpers; platform skips documented.",
        "cargo fmt; cargo test -p broker (skips noted) logged in session log.",
        "Integration prompt referenced in END log."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Set R13-test to in_progress, update session_log.md with START entry, commit docs update (`git commit -am \"docs: start R13-test\"`)",
        "Create task branch cr-r13-broker-test",
        "Create worktree wt/cr-r13-broker-test from that branch"
      ],
      "end_checklist": [
        "Ensure required tests are green; capture outputs for END log",
        "Commit worktree changes with descriptive message",
        "Merge task branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; reference integration prompt",
        "Commit docs update on feat/crate-refactor (`git commit -am \"docs: finish R13-test\"`)"
      ],
      "depends_on": [
        "R12-integ"
      ],
      "concurrent_with": [
        "R13-code"
      ],
      "worktree": "wt/cr-r13-broker-test",
      "integration_task": "R13-integ",
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R13-test.md"
    },
    {
      "id": "R13-integ",
      "name": "Integrate broker/lib slimming",
      "type": "integration",
      "phase": "Crate Refactor",
      "status": "pending",
      "description": "Merge R13 code/test broker splits, resolve conflicts, ensure fmt/clippy/tests are green.",
      "references": [
        "docs/project_management/next/refactor/refactor_plan.md",
        "crates/broker/src/lib.rs",
        "crates/broker/tests"
      ],
      "acceptance_criteria": [
        "wt/cr-r13-broker-integ merges R13 code+tests with clean fmt/clippy/test runs for broker.",
        "feat/crate-refactor updated with integration results and doc/task/log entries.",
        "Follow-up prompts/notes captured before closing the session."
      ],
      "start_checklist": [
        "Checkout feat/crate-refactor, pull latest",
        "Confirm R13-code/test completed",
        "Set R13-integ to in_progress, update session_log.md with START entry, commit docs update (`git commit -am \"docs: start R13-integ\"`)",
        "Create task branch cr-r13-broker-integ",
        "Create worktree wt/cr-r13-broker-integ from that branch"
      ],
      "end_checklist": [
        "Merge code/test branches into integration branch/worktree and resolve conflicts",
        "Run required fmt/clippy/tests noted in prompts",
        "Merge integration branch back to feat/crate-refactor",
        "Update tasks.json + session_log.md with END entry; push or hand off"
      ],
      "depends_on": [
        "R13-code",
        "R13-test"
      ],
      "concurrent_with": [],
      "worktree": "wt/cr-r13-broker-integ",
      "integration_task": null,
      "kickoff_prompt": "docs/project_management/next/refactor/kickoff_prompts/R13-integ.md"
    }
  ]
}
