# Kickoff: {{TASK_ID}} (integration core)

## Scope
- Merge code + tests, resolve drift to spec, and make the slice green on the primary dev platform.
- Spec: `{{FEATURE_DIR}}/{{SPEC_FILE}}`
- Execution workflow standard: `docs/project_management/standards/TASK_TRIADS_WORKTREE_EXECUTION_STANDARD.md`

## Start Checklist
Do not edit planning docs inside the worktree.

1. Verify you are in the task worktree `{{WORKTREE}}` on branch `{{BRANCH}}` and that `.taskmeta.json` exists at the worktree root.
2. Read: `{{FEATURE_DIR}}/plan.md`, `{{FEATURE_DIR}}/tasks.json`, `{{FEATURE_DIR}}/session_log.md`, spec, this prompt.
3. If `.taskmeta.json` is missing or mismatched, stop and ask the operator to run:
   - `make triad-task-start FEATURE_DIR="{{FEATURE_DIR}}" TASK_ID="{{TASK_ID}}"`

## Requirements
- Reconcile code/tests to spec (spec wins).
- If the slice is too large to make green deterministically (multiple subsystems, many unrelated acceptance bullets), stop and ask the operator to split the slice before continuing.
- Merge code+test branches into this worktree, then run required integration gates (must be green before any CI smoke dispatch):
  - `cargo fmt`
  - `cargo clippy --workspace --all-targets -- -D warnings`
  - relevant tests
  - `make integ-checks`
- Optional (once per feature, when you want a clean-cache assurance): `make preflight`

### Local behavioral smoke preflight (required when possible; fast fail before CI dispatch)

If `{{FEATURE_DIR}}/smoke/` exists and this machine matches a behavior platform for this feature, run the matching smoke script **locally** before dispatching compile parity or Feature Smoke.

Determine behavior platforms:
- `jq -r '.meta.behavior_platforms_required // [] | join(\",\")' "{{FEATURE_DIR}}/tasks.json"`

Preflight steps (choose the block matching your current platform):

Linux:
```bash
set -euo pipefail
cargo build --bin substrate
export PATH="$PWD/target/debug:$PATH"
bash "{{FEATURE_DIR}}/smoke/linux-smoke.sh"
```

macOS:
```bash
set -euo pipefail
cargo build --bin substrate
export PATH="$PWD/target/debug:$PATH"
bash "{{FEATURE_DIR}}/smoke/macos-smoke.sh"
```

Windows (PowerShell):
```powershell
$ErrorActionPreference = "Stop"
cargo build --bin substrate
$env:Path = "$pwd\\target\\debug;$env:Path"
pwsh -File "{{FEATURE_DIR}}\\smoke\\windows-smoke.ps1"
```

Expected:
- Exit `0`.

### Cross-platform compile parity (CI dispatch; required before smoke)

Before dispatching Feature Smoke (especially when using `RUNNER_KIND=self-hosted`), run a fast cross-platform compile parity preflight on GitHub-hosted runners to catch macOS/Windows compilation breaks early:
- `make ci-compile-parity CI_WORKFLOW_REF="{{ORCH_BRANCH}}" CI_REMOTE=origin CI_CLEANUP=1`

Notes:
- This dispatches CI Testing in `mode=compile-parity` (fmt --check, check --all-targets, clippy -D warnings) across Linux/macOS/Windows.
- If it fails, fix compile parity **in this integ-core worktree/branch** (cfg/platform guards), commit, and re-run until green; do not proceed to Feature Smoke until it is green.

### Cross-platform smoke (CI dispatch; validation-only)

Run CI smoke from this **integration-core worktree**, because the smoke dispatcher tests the current `HEAD` by creating a throwaway remote branch at that commit.

Important (P3-008):
- Smoke is required only for the feature’s **behavior platforms** (`tasks.json` meta: `behavior_platforms_required`).
- CI parity may be required for a broader set of platforms (`tasks.json` meta: `ci_parity_platforms_required` / legacy `platforms_required`).

Recommended dispatch (explicit params; leave `CLEANUP=1` on unless debugging temp branches):

1) Dispatch behavioral smoke in a single run (preferred):
   - `make feature-smoke FEATURE_DIR="{{FEATURE_DIR}}" PLATFORM=behavior RUNNER_KIND=self-hosted WORKFLOW_REF="{{ORCH_BRANCH}}" REMOTE=origin CLEANUP=1 RUN_INTEG_CHECKS=1`
   - If WSL coverage is required for this feature, add `RUN_WSL=1`.

What the dispatcher does (`scripts/ci/dispatch_feature_smoke.sh` via `make feature-smoke`):
- Creates/pushes a throwaway branch like `tmp/feature-smoke/<feature>/<platform>/<ts>` at current `HEAD`.
- Dispatches the workflow from `WORKFLOW_REF` while checking out that throwaway branch.
- Prints `DISPATCH_OK=0|1`, `RUN_ID=<id>`, `RUN_URL=<url>`, `SMOKE_PASSED_PLATFORMS=<csv>`, and `SMOKE_FAILED_PLATFORMS=<csv>` (plus `ERROR_KIND`/`ERROR_MESSAGE` on failures).
- Deletes the throwaway remote branch when `CLEANUP=1`.

Note:
- If smoke fails, `make feature-smoke` will still print `DISPATCH_OK=1` + `RUN_ID`/`RUN_URL`, but will exit non-zero (GNU make typically reports this as exit code 2). Do not re-run just to “get a run id”; use `RUN_URL` to inspect failures and start platform-fix tasks as needed.

If any platform smoke fails:
- Do not attempt platform-specific fixes in integ-core.
- Ask the operator to start only the failing platform-fix tasks **from the orchestration checkout** (not from a task worktree):
  - If you have a single smoke run that covers multiple platforms (typical `PLATFORM=behavior` case):
    - `make triad-task-start-platform-fixes-from-smoke FEATURE_DIR="{{FEATURE_DIR}}" SLICE_ID="<slice>" SMOKE_RUN_ID="<run-id>" LAUNCH_CODEX=1`
  - If you dispatched per-platform smoke (multiple run ids):
    - `make triad-task-start-platform-fixes FEATURE_DIR="{{FEATURE_DIR}}" SLICE_ID="<slice>" PLATFORMS="<csv>" LAUNCH_CODEX=1`
  - `<slice>` is the triad id prefix (e.g., `C0`, `C3`).
  - `<run-id>` is the `RUN_ID` from the failing smoke run (only used for `triad-task-start-platform-fixes-from-smoke`).
  - `<csv>` is the comma-separated list of platforms you need platform-fix tasks for (typically the failing behavior platforms, plus `wsl` if `wsl_task_mode="separate"`).

If behavioral smoke is green for all behavior platforms:
- Platform-fix tasks (if present in the pack) may still be required for CI-only failures (e.g., clippy warnings on macOS/Windows), so do not mark them no-op yet.
- The wrapper/final gate should run CI Testing; if CI Testing is green, then mark platform-fix tasks `completed` as no-ops to unblock the final aggregator’s `depends_on`:
  - `scripts/triad/mark_noop_platform_fixes_completed.sh --feature-dir "{{FEATURE_DIR}}" --slice-id "<slice>"` (optional: add `--from-smoke-run "<run-id>"` for logging)

Once all required platform-fix tasks are completed, ask the operator to start the final aggregator from the orchestration checkout:
- `make triad-task-start-integ-final FEATURE_DIR="{{FEATURE_DIR}}" SLICE_ID="<slice>" LAUNCH_CODEX=1`

## End Checklist
1. Ensure your merged state is committed and local integration gates are green:
   - From inside the worktree, run: `make triad-task-finish TASK_ID="{{TASK_ID}}"`
2. Dispatch cross-platform smoke from this worktree and include these exact key/value lines in your handoff (wrapper agents parse them):
   - `RUN_ID=<id>`
   - `RUN_URL=<url>` (if printed)
   - `SMOKE_PASSED_PLATFORMS=<csv>`
   - `SMOKE_FAILED_PLATFORMS=<csv>` (empty means success)
3. Hand off run ids/URLs and next-step instructions to the operator (do not edit planning docs inside the worktree).
4. Do not delete the worktree (feature cleanup removes worktrees at feature end).
