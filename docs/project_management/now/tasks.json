{
  "session_log": [
    {
      "timestamp": "2025-10-24T14:20:00Z",
      "summary": "Stage 1 gating/backoff complete; updated shell to use std IsTerminal and added dev shim helper.",
      "highlights": [
        "Replaced atty usage with std::io::IsTerminal across shell (`crates/shell/src/lib.rs`, `crates/shell/Cargo.toml`, `Cargo.lock`).",
        "Added early TTY exit in `run_shell` and PTY heuristics, stopping busy-spin when stdin/stdout are not TTYs.",
        "Vendor-rebased Reedline fork under `third_party/reedline/` to adjust poll backoff, wiring consumers via `[patch.crates-io]`.",
        "Introduced `scripts/substrate/dev-shim-bootstrap.sh` for local shim install/uninstall cycles."
      ],
      "tests": [
        "/usr/bin/cargo test -p substrate-shell"
      ],
      "notes": "Stage 1 tasks `stage1-tty-gating` and `stage1-input-backoff` marked complete."
    },
    {
      "timestamp": "2025-10-24T14:55:00Z",
      "summary": "Verified idle CPU relief and documented measurements.",
      "highlights": [
        "Captured `top -b -d 1 -n 5 -p <pid>` sample showing 0.0% CPU at idle after fixes.",
        "Annotated Stage 1 doc with timestamped verification note.",
        "Updated tasks.json to set `stage1-idle-verification` status."
      ],
      "tests": [],
      "notes": "Stage 1 complete; ready to start Stage 2."
    },
    {
      "timestamp": "2025-10-24T15:05:00Z",
      "summary": "Added `--async-repl` flag plumbing and docs (Stage 2 kickoff).",
      "highlights": [
        "Extended Clap CLI (`crates/shell/src/lib.rs`) and ShellConfig to carry `async_repl` flag.",
        "Documented flag in `docs/USAGE.md` and `docs/CONFIGURATION.md`.",
        "Marked `stage2-cli-flag` task complete."
      ],
      "tests": [
        "/usr/bin/cargo test -p substrate-shell"
      ],
      "notes": "Async loop implementation pending."
    },
    {
      "timestamp": "2025-10-24T15:30:00Z",
      "summary": "Implemented async REPL skeleton with tokio runtime (Stage 2 progress).",
      "highlights": [
        "Added `run_async_repl` with Tokio current-thread runtime, stdin `tokio::select!`, and placeholder agent channel.",
        "Expanded tokio features and derived `Clone` for `ShellConfig`.",
        "Updated tasks.json to set `stage2-async-loop` status."
      ],
      "tests": [
        "/usr/bin/cargo test -p substrate-shell"
      ],
      "notes": "Remaining Stage 2 work: prompt preservation, agent channel integration, smoke test."
    },
    {
      "timestamp": "2025-10-25T17:00:00Z",
      "summary": "Finished Stage 2 prompt redraw and agent event plumbing for async REPL.",
      "highlights": [
        "Refactored async REPL into `crates/shell/src/async_repl.rs` with raw-mode line editing and ANSI-safe redraw helper.",
        "Introduced thread-backed demo producer via global agent channel so `:demo-agent` enqueues streamed messages.",
        "Broadcast command completion notifications through `publish_agent_event`, ensuring prompt survives interleaved output."
      ],
      "tests": [
        "/home/spenser/.cargo/bin/cargo test -p substrate-shell",
        "Manual: `target/debug/substrate --async-repl --no-world` with `:demo-agent`, partial input typing, and `pidstat -p <pid> 1 5` idle check"
      ],
      "notes": "Stage 2 prompt redraw, agent channel, and smoke test tasks marked complete."
    },
    {
      "timestamp": "2025-10-26T18:30:00Z",
      "summary": "Hooked shared agent event bus and non-polling renderer into both REPL modes (Stage 3 kickoff).",
      "highlights": [
        "Added `agent_events` module to `substrate-common` and shell, centralising the global channel and event formatting.",
        "Async REPL now renders structured agent events via shared helpers; interactive Reedline path streams events through `ExternalPrinter` with prompt-safe redraw.",
        "Command completion notifications, demo helper, and idle CPU checks verified against the new infrastructure."
      ],
      "tests": [
        "/home/spenser/.cargo/bin/cargo check -p substrate-shell",
        "/home/spenser/.cargo/bin/cargo test -p substrate-shell",
        "Manual: `target/debug/substrate --no-world`, run `:demo-agent` while typing to confirm prompt integrity and streaming output",
        "Manual: `top -b -d 1 -n 5 -p <pid>` idle capture stored in /tmp/async_repl_top.txt"
      ],
      "notes": "Stage 3 renderer thread groundwork landed; PTY/world-agent integration still pending."
    },
    {
      "timestamp": "2025-10-27T19:30:00Z",
      "summary": "Streamed non-PTY commands end-to-end and verified async shell integration.",
      "highlights": [
        "Replaced buffered agent exec with NDJSON streaming backed by shared world helpers, emitting AgentEvent chunks into both Reedline and async REPL paths.",
        "Extended agent API/client/host-proxy to expose /v1/execute/stream across Linux/macOS/Windows transports with incremental fs diff handling.",
        "Added host-side stdout/stderr streaming to reuse the same event bus when bypassing the world agent."
      ],
      "tests": [
        "source /home/spenser/.substrate/dev-shim-env.sh && /usr/bin/cargo test -p substrate-shell --test integration"
      ],
      "notes": "Stage 3 streaming refactor landed; remaining task is high-throughput validation before moving to Stage 4."
    },
    {
      "timestamp": "2025-10-27T20:05:00Z",
      "summary": "Completed Stage 3 high-throughput validation with demo burst helper and Ctrl+C checks.",
      "highlights": [
        "Added :demo-burst helper and stress script (scripts/dev/async_repl_stress.py) to fan out multi-agent events.",
        "Measured 4x500 burst at ~19.7k events/sec; Ctrl+C cleanly interrupts busy stream.",
        "Captured run output in docs/project_management/now/stage3_high_throughput_run_2025-10-27.txt."
      ],
      "tests": [
        "python scripts/dev/async_repl_stress.py --agents 4 --events 500 --delay-ms 0",
        "source /home/spenser/.substrate/dev-shim-env.sh && /usr/bin/cargo test -p substrate-shell --test integration"
      ],
      "notes": "Stage 3 validation now complete; ready to roll into Stage 4 tasks."
    },
    {
      "timestamp": "2025-10-29T13:00:00Z",
      "summary": "Stage 4 automated streaming tests landed.",
      "highlights": [
        "Added unit coverage for :demo-burst scheduling (crates/shell/src/agent_events.rs) and stream-frame handling (crates/shell/src/lib.rs).",
        "Validated burst helper and stream chunk path via `source /home/spenser/.substrate/dev-shim-env.sh && /usr/bin/cargo test -p substrate-shell`.",
        "Introduced scripts/dev/async_repl_stress.py for repeatable throughput checks (\u224819.7k events/sec)."
      ],
      "tests": [
        "source /home/spenser/.substrate/dev-shim-env.sh && /usr/bin/cargo test -p substrate-shell",
        "python scripts/dev/async_repl_stress.py --agents 4 --events 500 --delay-ms 0"
      ],
      "notes": "Stage4-automated-tests marked completed; moving on to idle metric capture."
    },
    {
      "timestamp": "2025-10-29T13:06:30Z",
      "summary": "Captured async idle CPU metrics on Linux for Stage 4.",
      "highlights": [
        "New helper scripts/dev/async_repl_metrics.py records top output during async idle sessions.",
        "Log stored at docs/project_management/now/stage4_idle_top_linux.txt shows substrate idling at ~0% CPU across five samples.",
        "Cleaned stray async processes before measurement to ensure accuracy."
      ],
      "tests": [
        "python scripts/dev/async_repl_metrics.py"
      ],
      "notes": "Stage4-idle-metrics now completed; macOS capture still pending for future coverage."
    },
    {
      "timestamp": "2025-10-30T16:00:00Z",
      "summary": "Automated prompt drills and added REPL observability hooks for Stage 4.",
      "highlights": [
        "Introduced scripts/dev/async_repl_prompt_checks.py to exercise typing, long-line, and backspace scenarios while streaming agent output; transcript stored at docs/project_management/now/stage4_prompt_checks_transcript.txt.",
        "Interactive shell now logs repl_status start/stop events with input/agent/command counters, and `repl_mode` is tagged on command span logs.",
        "Updated docs/TRACE.md with the new observability section covering REPL mode tagging and metrics."
      ],
      "tests": [
        "python scripts/dev/async_repl_prompt_checks.py --log docs/project_management/now/stage4_prompt_checks_transcript.txt",
        "/usr/bin/cargo test -p substrate-shell"
      ],
      "notes": "Stage4-prompt-checks and stage4-observability marked complete; next up is rollout planning."
    },
    {
      "timestamp": "2025-10-30T18:00:00Z",
      "summary": "Flipped async REPL on by default with fallback flag documented (Stage 4 rollout).",
      "highlights": [
        "CLI now defaults to async mode; new `--legacy-repl` flag re-enables the synchronous Reedline loop for emergency use.",
        "Updated developer docs (USAGE/CONFIGURATION + Phase 4 plan) to describe the rollout and escape hatch.",
        "Refreshed automation scripts to rely on the default async mode and retained telemetry coverage for both loops."
      ],
      "tests": [
        "target/debug/substrate --legacy-repl --no-world",
        "/usr/bin/cargo test -p substrate-shell"
      ],
      "notes": "Stage4-rollout complete; next milestone is pruning legacy code once the fallback stops seeing usage."
    },
    {
      "timestamp": "2025-11-01T16:20:00Z",
      "summary": "Outlined Stage 5 editor parity plan and broke work into actionable tasks.",
      "highlights": [
        "Reviewed prior Stage 1-4 deliverables and current async REPL implementation to identify gaps.",
        "Authored stage5_editor_parity_plan.md capturing the async Reedline adapter approach and risk analysis.",
        "Split Stage 5 into design, shared core, history/completion, cursor/multiline, and regression validation tasks.",
        "Expanded stage5_editor_parity_plan.md with per-task deliverables, code references, and log/metrics expectations for Stage 5 execution.",
        "Updated Stage 5 task acceptance/tests to mandate history verification, prompt drill transcripts, and idle-metrics artifacts in docs/project_management/now/."
      ],
      "tests": [],
      "notes": "Stage 5 tasks depend on Stage 4 rollout; doc records open questions for completions and debug flags."
    },
    {
      "timestamp": "2025-11-01T17:05:00Z",
      "summary": "Completed Stage 5 async Reedline adapter design.",
      "highlights": [
        "Documented AsyncReedlineAdapter architecture, event flow, and stdout locking in stage5_editor_parity_plan.md.",
        "Recorded design decision comparing adapter vs. blocking Reedline loop with consequences and follow-up actions.",
        "Confirmed debug fallback strategy relies on --legacy-repl unless instability forces a minimal editor flag later."
      ],
      "tests": [
        "Manual: verified updated stage5_editor_parity_plan.md against crates/shell/src/lib.rs:1736-1928 and crates/shell/src/async_repl.rs:35-254."
      ],
      "notes": "No new debug flag introduced; existing --legacy-repl remains documented fallback."
    },
    {
      "timestamp": "2025-11-01T17:40:00Z",
      "summary": "Extracted shared Reedline builder for sync/async parity groundwork.",
      "highlights": [
        "Introduced crates/shell/src/editor.rs with build_editor/make_prompt returning EditorSetup { line_editor, printer }.",
        "Refactored run_interactive_shell to consume shared builder and ExternalPrinter handle while preserving agent streaming thread.",
        "Ran cargo fmt --check and cargo test -p substrate-shell to confirm no regressions."
      ],
      "tests": [
        "/usr/bin/cargo fmt -- --check",
        "/usr/bin/cargo test -p substrate-shell"
      ],
      "notes": "Shared builder now centralises history/completer/keymaps for future async adapter integration."
    },
    {
      "timestamp": "2025-11-01T18:05:00Z",
      "summary": "Wired async REPL to shared Reedline core for history/completion parity.",
      "highlights": [
        "Replaced manual async editor loop with AsyncReedlineAdapter that feeds Reedline::process_events (crates/shell/src/async_repl.rs, third_party/reedline/src/engine.rs).",
        "Hooked agent streaming via ExternalPrinter in async mode and added Stage 5 prompt drill automation script entry.",
        "Bumped crossterm to 0.28.1 to align with Reedline event types and regenerated async prompt drill tooling."
      ],
      "tests": [
        "/usr/bin/cargo test -p substrate-shell",
        "/usr/bin/cargo fmt -- --check",
        "Manual: python scripts/dev/async_repl_prompt_checks.py --log docs/project_management/now/stage4_prompt_checks_transcript.txt --stage5-log docs/project_management/now/stage5_prompt_checks_transcript.txt (requires functional substrate world environment)."
      ],
      "notes": "Script prepares Stage 5 transcript capture; execute once substrate runtime is available."
    },
    {
      "timestamp": "2025-11-01T18:45:00Z",
      "summary": "Enabled async cursor/multiline editing via Reedline adapter.",
      "highlights": [
        "Adapted AsyncReedlineAdapter to stream crossterm events through Reedline::process_events, unlocking cursor movement, multi-line editing, and undo support.",
        "Synced agent output with Reedline painter by sharing ExternalPrinter handles and flushing via process_events.",
        "Extended prompt drill tooling to capture Stage 5 history/completion transcripts alongside Stage 4 scenarios."
      ],
      "tests": [
        "/usr/bin/cargo fmt -- --check",
        "/usr/bin/cargo test -p substrate-shell -- --test-threads=1",
        "Manual: python scripts/dev/async_repl_prompt_checks.py --log docs/project_management/now/stage4_prompt_checks_transcript.txt --stage5-log docs/project_management/now/stage5_prompt_checks_transcript.txt"
      ],
      "notes": "Run the updated prompt drill script once substrate world is available to capture Stage 5 transcript."
    },
    {
      "timestamp": "2025-11-02T00:30:00Z",
      "summary": "Captured residual multi-line issues after adapter upgrades.",
      "highlights": [
        "Validated async adapter changes for continuation handling and prompt cleanup across commands.",
        "Observed lingering CSI cursor reports when launching REPL-style binaries (python, sqlite3).",
        "Noted need for another pass to remove manual redraw hacks and rely solely on Reedline APIs."
      ],
      "tests": [
        "/usr/bin/cargo fmt -- --check",
        "/usr/bin/cargo test -p substrate-shell -- --test-threads=1"
      ],
      "notes": "Stage 5 regression/validation remains open; next session should audit Reedline integration to eliminate stray escape sequences."
    }
  ],
  "version": 1,
  "goal": "Eliminate the Reedline busy-spin while delivering an async, prompt-safe agent output pipeline across macOS/Linux/Windows, then roll it out with confidence.",
  "source": "docs/project_management/now/Fixing REPL Busy-Spin and Implementing Async Agent Output_ Plan & Steps.docx.md",
  "meta": [
    "Stage 1 mitigations are temporary safety nets; once Stage 2 async REPL ships and proves stable, remove or behind feature flag.",
    "Stage 2 introduces the runtime flag `--async-repl` (and matching cargo feature if required) that later stages assume is present.",
    "Stages are sequential; do not begin Stage 3 streaming work until Stage 2 async loop passes smoke testing.",
    "See PHASE_4_CONCURRENT_OUTPUT_DESIGN.md \u00a7Async REPL (lines 30-155) and PHASE_4_5_ADVANCED_FEATURES_PLAN.md \u00a7Part A / Appendix B for design intent.",
    "Manual testing expectations are tracked in Stage 4; gather evidence (screenshots, command outputs) for PR review."
  ],
  "stages": [
    {
      "name": "Stage 1: Immediate Busy-Spin Mitigation",
      "overview": "Short-lived guardrails to stop the macOS core burn while the async path is under construction.",
      "tasks": [
        {
          "id": "stage1-tty-gating",
          "title": "Gate interactive REPL on real TTY",
          "description": "Detect non-TTY stdin at startup and skip the Reedline loop (enter headless mode or exit with guidance).",
          "references": [
            "docs/project_management/now/Fixing REPL Busy-Spin and Implementing Async Agent Output_ Plan & Steps.docx.md (Stage 1, item 1)",
            "docs/project_management/future/PHASE_4_CONCURRENT_OUTPUT_DESIGN.md#L9-L13"
          ],
          "files": [
            "crates/shell/src/lib.rs",
            "crates/shell/src/bin.rs"
          ],
          "dependencies": [],
          "acceptance": [
            "Launching `substrate` with stdin redirected (e.g. `echo` or `systemd` service) no longer enters the interactive loop.",
            "When no TTY is present, the process exits gracefully or runs in headless mode without reporting Reedline errors."
          ],
          "tests": [
            "Manual: `printf '' | target/debug/substrate` should exit without high CPU usage.",
            "Optional: add unit test around new `is_tty` helper if feasible."
          ],
          "status": "complete"
        },
        {
          "id": "stage1-input-backoff",
          "title": "Add interim poll/backoff to current loop",
          "description": "Wrap crossterm event polling with a timeout plus short sleep so the legacy Reedline loop no longer busy spins on macOS.",
          "references": [
            "docs/project_management/now/Fixing REPL Busy-Spin and Implementing Async Agent Output_ Plan & Steps.docx.md (Stage 1, item 2)",
            "docs/project_management/future/PHASE_4_CONCURRENT_OUTPUT_DESIGN.md#L22-L27"
          ],
          "files": [
            "crates/shell/src/lib.rs",
            "third_party/reedline"
          ],
          "dependencies": [
            "stage1-tty-gating"
          ],
          "acceptance": [
            "Idle `substrate` on macOS reports <0.5% CPU before async work begins.",
            "Reedline responsiveness (tab completion, history) remains unaffected by the timeout."
          ],
          "tests": [
            "Manual: `powermetrics --samplers tasks -i 5` or `top` showing near-zero CPU while shell idles.",
            "Automated: `cargo test -p substrate-shell` (existing suite) passes."
          ],
          "status": "complete"
        },
        {
          "id": "stage1-idle-verification",
          "title": "Verify near-zero idle CPU after mitigations",
          "description": "Record before/after measurements to confirm Stage 1 changes solved the immediate regression.",
          "references": [
            "docs/project_management/now/Fixing REPL Busy-Spin and Implementing Async Agent Output_ Plan & Steps.docx.md (Stage 1, item 3)"
          ],
          "files": [],
          "dependencies": [
            "stage1-tty-gating",
            "stage1-input-backoff"
          ],
          "acceptance": [
            "Documented measurements (<0.1% CPU target) attached to issue/PR.",
            "Mac idle scenario reproduced in CI or local script if possible."
          ],
          "tests": [
            "Manual data collection only; no automated test required."
          ],
          "status": "complete"
        }
      ]
    },
    {
      "name": "Stage 2: Async Event Infrastructure (Prompt-Friendly)",
      "overview": "Introduce the async REPL path behind `--async-repl`, keeping prompt integrity even without streaming agents yet.",
      "tasks": [
        {
          "id": "stage2-cli-flag",
          "title": "Introduce --async-repl opt-in path",
          "description": "Add clap flag/config toggle plus cargo feature (if needed) to route interactive sessions into the async loop.",
          "references": [
            "docs/project_management/now/Fixing REPL Busy-Spin and Implementing Async Agent Output_ Plan & Steps.docx.md (Stage 2, item 1)",
            "docs/project_management/future/PHASE_4_CONCURRENT_OUTPUT_DESIGN.md#L83-L101"
          ],
          "files": [
            "crates/shell/src/lib.rs",
            "crates/shell/src/config.rs",
            "crates/shell/src/cli.rs"
          ],
          "dependencies": [
            "stage1-idle-verification"
          ],
          "acceptance": [
            "`substrate --async-repl` runs the new async path; legacy behavior remains default.",
            "Flag is documented in `--help` output and config docs if applicable."
          ],
          "tests": [
            "`cargo test -p substrate-shell`",
            "Manual: launch with and without flag to ensure selection works."
          ],
          "status": "complete"
        },
        {
          "id": "stage2-async-loop",
          "title": "Implement async_run_repl with tokio::select!",
          "description": "Build the async loop waiting on stdin lines and agent event receiver without busy waits.",
          "references": [
            "docs/project_management/now/Fixing REPL Busy-Spin and Implementing Async Agent Output_ Plan & Steps.docx.md (Stage 2, item 2)",
            "docs/project_management/future/PHASE_4_CONCURRENT_OUTPUT_DESIGN.md#L50-L129"
          ],
          "files": [
            "crates/shell/src/async_repl.rs",
            "crates/shell/src/lib.rs"
          ],
          "dependencies": [
            "stage2-cli-flag"
          ],
          "acceptance": [
            "Async loop handles EOF, Ctrl+C/D, and empty input without panic.",
            "No polling\u2014verified by reading code path or using tracing logs (optional)."
          ],
          "tests": [
            "`cargo fmt --all && cargo clippy --workspace --all-targets`",
            "Manual: run `substrate --async-repl` and ensure prompt operates line-by-line."
          ],
          "status": "complete"
        },
        {
          "id": "stage2-prompt-redraw",
          "title": "Preserve prompt when printing async events",
          "description": "Implement carriage-return clear or Reedline suspend guard so async prints don\u2019t corrupt current input.",
          "references": [
            "docs/project_management/now/Fixing REPL Busy-Spin and Implementing Async Agent Output_ Plan & Steps.docx.md (Stage 2, item 3)",
            "docs/project_management/future/PHASE_4_CONCURRENT_OUTPUT_DESIGN.md#L70-L78"
          ],
          "files": [
            "crates/shell/src/async_repl.rs",
            "third_party/reedline"
          ],
          "dependencies": [
            "stage2-async-loop"
          ],
          "acceptance": [
            "Typing while triggering a dummy event restores the prompt and partial input.",
            "ANSI control handling verified on macOS and Linux terminals."
          ],
          "tests": [
            "Manual: type `echo foo` halfway, inject dummy event, confirm prompt redraw.",
            "Optional: add unit test around redraw helper if possible."
          ],
          "status": "complete"
        },
        {
          "id": "stage2-agent-channel",
          "title": "Wire initial agent event channel",
          "description": "Set up tokio mpsc sender/receiver and spawn prototype listener that feeds events into async loop.",
          "references": [
            "docs/project_management/now/Fixing REPL Busy-Spin and Implementing Async Agent Output_ Plan & Steps.docx.md (Stage 2, item 4)",
            "PHASE_4_CONCURRENT_OUTPUT_DESIGN.md#L108-L127"
          ],
          "files": [
            "crates/shell/src/async_repl.rs",
            "crates/shell/src/lib.rs"
          ],
          "dependencies": [
            "stage2-async-loop"
          ],
          "acceptance": [
            "Dummy event sender prints lines via async loop without blocking stdin.",
            "Channel is globally accessible for later stages."
          ],
          "tests": [
            "Manual: instrument code to send mock events and observe output order."
          ],
          "status": "complete"
        },
        {
          "id": "stage2-smoke-test",
          "title": "Smoke-test async mode",
          "description": "Exercise async path with dummy agent events, confirming idle CPU near zero and no regressions.",
          "references": [
            "docs/project_management/now/Fixing REPL Busy-Spin and Implementing Async Agent Output_ Plan & Steps.docx.md (Stage 2, item 5)"
          ],
          "files": [],
          "dependencies": [
            "stage2-agent-channel",
            "stage2-prompt-redraw"
          ],
          "acceptance": [
            "Idle async mode consumes <0.1% CPU on macOS and Linux.",
            "Basic commands run successfully via async loop."
          ],
          "tests": [
            "Manual powermetrics/top capture documented with screenshots or logs."
          ],
          "status": "pending"
        }
      ]
    },
    {
      "name": "Stage 3: Concurrent Agent Output Integration",
      "overview": "Stream real agent output through the shell using the non-polling renderer from the Phase 4.5 plan.",
      "tasks": [
        {
          "id": "stage3-stream-source",
          "title": "Enable streaming agent output",
          "description": "Upgrade world-agent/host-proxy to push stdout/stderr chunks (start simple with direct WS) while remaining Hub-compatible later.",
          "references": [
            "docs/project_management/now/Fixing REPL Busy-Spin and Implementing Async Agent Output_ Plan & Steps.docx.md (Stage 3, items 1-3)",
            "docs/project_management/future/PHASE_4_5_ADVANCED_FEATURES_PLAN.md#L942-L964"
          ],
          "files": [
            "crates/world-agent/src/handlers.rs",
            "crates/world-agent/src/service.rs",
            "crates/shell/src/lib.rs",
            "crates/host-proxy/src/lib.rs"
          ],
          "dependencies": [
            "stage2-smoke-test"
          ],
          "acceptance": [
            "Non-PTY commands stream output incrementally rather than buffering entire result.",
            "API maintains backwards compatibility (tests for existing ExecuteResponse still pass)."
          ],
          "tests": [
            "`cargo test -p world-agent`",
            "Manual: run a command that prints gradually and observe streaming behaviour."
          ],
          "status": "complete"
        },
        {
          "id": "stage3-renderer-thread",
          "title": "Start blocking renderer thread with Reedline suspend",
          "description": "Spawn background thread that blocking-recv on event channel, uses suspend_guard/ANSI clears, and redraws prompt.",
          "references": [
            "docs/project_management/now/Fixing REPL Busy-Spin and Implementing Async Agent Output_ Plan & Steps.docx.md (Stage 3, items 4-6)",
            "PHASE_4_5_ADVANCED_FEATURES_PLAN.md#L978-L998"
          ],
          "files": [
            "crates/shell/src/async_repl.rs",
            "third_party/reedline"
          ],
          "dependencies": [
            "stage3-stream-source"
          ],
          "acceptance": [
            "Renderer prints agent lines above the prompt without corruption on macOS/Linux/Windows.",
            "Thread terminates cleanly on shell exit (no orphan handles)."
          ],
          "tests": [
            "Manual: run streaming command while typing; ensure prompt stays intact.",
            "Automated: consider integration test injecting synthetic events (optional)."
          ],
          "status": "complete"
        },
        {
          "id": "stage3-event-plumbing",
          "title": "Define AgentEvent struct and global channel",
          "description": "Create shared event schema (id, kind, payload) and OnceCell sender accessible by shell/world components.",
          "references": [
            "docs/project_management/now/Fixing REPL Busy-Spin and Implementing Async Agent Output_ Plan & Steps.docx.md (Stage 3, item 6)",
            "PHASE_4_5_ADVANCED_FEATURES_PLAN.md#L48-L88"
          ],
          "files": [
            "crates/common/src/lib.rs",
            "crates/shell/src/async_repl.rs",
            "crates/world-agent/src/service.rs"
          ],
          "dependencies": [
            "stage3-renderer-thread"
          ],
          "acceptance": [
            "Event struct serialises/deserialises for future Hub usage.",
            "Sender initialised once per process and reused by command execution path."
          ],
          "tests": [
            "Unit tests for AgentEvent serde if practical."
          ],
          "status": "complete"
        },
        {
          "id": "stage3-command-refactor",
          "title": "Refactor non-PTY execute path for streaming",
          "description": "Adjust execute_command/exec_non_pty_via_* to enter streaming mode, finish spans/logs on completion events, and avoid blocking main loop.",
          "references": [
            "docs/project_management/now/Fixing REPL Busy-Spin and Implementing Async Agent Output_ Plan & Steps.docx.md (Stage 3, item 3)",
            "PHASE_4_5_ADVANCED_FEATURES_PLAN.md#AppendixB"
          ],
          "files": [
            "crates/shell/src/lib.rs",
            "crates/shell/src/async_repl.rs",
            "crates/shell/src/pty_exec.rs"
          ],
          "dependencies": [
            "stage3-event-plumbing"
          ],
          "acceptance": [
            "command_start log emitted before streaming begins; command_complete emitted after final event with correct exit code and fs_diff.",
            "Existing integration test `test_command_start_finish_json_roundtrip` still passes."
          ],
          "tests": [
            "`cargo test -p substrate-shell`",
            "Manual: run long `sleep`/`printf` combination and inspect trace logs."
          ],
          "status": "completed"
        },
        {
          "timestamp": "2025-10-30T20:30:00Z",
          "summary": "Documented remaining async REPL editing gaps and scheduled follow-up stage.",
          "highlights": [
            "Captured missing line-editing features (history, cursor movement, visual caret) as Stage 5 work items.",
            "Clarified that --legacy-repl remains the temporary workaround until Reedline parity returns."
          ],
          "tests": [],
          "notes": "Stage 4 remains complete; Stage 5 will cover advanced editor support."
        },
        {
          "id": "stage3-cross-platform",
          "title": "Implement platform transports for events",
          "description": "Ensure Linux (UDS), macOS (VSock/SSH tunnel), and Windows (TCP/pipe) transports deliver streaming events to the shell.",
          "references": [
            "docs/project_management/now/Fixing REPL Busy-Spin and Implementing Async Agent Output_ Plan & Steps.docx.md (Stage 3, item 4)",
            "PHASE_4_5_ADVANCED_FEATURES_PLAN.md#L956-L972"
          ],
          "files": [
            "crates/shell/src/platform_world/mod.rs",
            "crates/shell/src/platform_world/windows.rs",
            "crates/host-proxy/src/lib.rs",
            "docs/CONFIGURATION.md"
          ],
          "dependencies": [
            "stage3-command-refactor"
          ],
          "acceptance": [
            "Streaming confirmed on macOS Lima, Linux native, and Windows WSL (manual evidence for each).",
            "Transport metadata recorded in trace spans/telemetry where applicable."
          ],
          "tests": [
            "Manual platform checks; capture logs/metrics for PR."
          ],
          "status": "completed"
        },
        {
          "id": "stage3-high-throughput-validation",
          "title": "Exercise high-volume and multi-agent scenarios",
          "description": "Stress renderer with bursty output, multiple agents, and ensure Ctrl+C / shutdown signals operate cleanly.",
          "references": [
            "docs/project_management/now/Fixing REPL Busy-Spin and Implementing Async Agent Output_ Plan & Steps.docx.md (Stage 3, item 5)"
          ],
          "files": [],
          "dependencies": [
            "stage3-cross-platform"
          ],
          "acceptance": [
            "Renderer keeps up with >=1000 events/sec without prompt corruption.",
            "Ctrl+C interrupts streamed command while listener thread terminates without panic."
          ],
          "tests": [
            "Manual stress script (document commands)."
          ],
          "status": "completed"
        }
      ]
    },
    {
      "name": "Stage 4: Testing, Metrics & Rollout",
      "overview": "Codify automated coverage, document metrics, and plan the safe rollout of async REPL as default.",
      "tasks": [
        {
          "id": "stage4-automated-tests",
          "title": "Add automated coverage for streaming REPL",
          "description": "Add integration/unit tests simulating agent events and verifying interleaved output and log sequencing.",
          "references": [
            "docs/project_management/now/Fixing REPL Busy-Spin and Implementing Async Agent Output_ Plan & Steps.docx.md (Stage 4, item 1)"
          ],
          "files": [
            "crates/shell/tests/integration.rs",
            "crates/shell/src/async_repl.rs"
          ],
          "dependencies": [
            "stage3-command-refactor"
          ],
          "acceptance": [
            "New tests fail on regressions and pass in clean build; cover command_start/command_complete timing.",
            "CI runs `cargo test --workspace -- --nocapture` without flakiness."
          ],
          "tests": [
            "`cargo test --workspace -- --nocapture` in CI/local."
          ],
          "status": "completed"
        },
        {
          "id": "stage4-idle-metrics",
          "title": "Document idle CPU benchmarks",
          "description": "Record final idle CPU on macOS & Linux (async mode with agents connected) and store results in project docs or PR.",
          "references": [
            "docs/project_management/now/Fixing REPL Busy-Spin and Implementing Async Agent Output_ Plan & Steps.docx.md (Stage 4, item 2)"
          ],
          "files": [
            "docs/project_management/now/Fixing REPL Busy-Spin and Implementing Async Agent Output_ Plan & Steps.docx.md"
          ],
          "dependencies": [
            "stage4-automated-tests"
          ],
          "acceptance": [
            "Powermetrics/top screenshots or logs show <0.1% CPU idle with async mode active.",
            "Benchmarks linked in PR or release notes."
          ],
          "tests": [
            "Manual measurement only (document commands)."
          ],
          "status": "completed"
        },
        {
          "id": "stage4-prompt-checks",
          "title": "Manual prompt integrity drills",
          "description": "Run scripted scenarios (typing mid-output, long lines, control chars) and confirm prompt redraw holds up.",
          "references": [
            "docs/project_management/now/Fixing REPL Busy-Spin and Implementing Async Agent Output_ Plan & Steps.docx.md (Stage 4, item 3)"
          ],
          "files": [
            "scripts/dev/async_repl_prompt_checks.py",
            "docs/project_management/now/stage4_prompt_checks_transcript.txt"
          ],
          "dependencies": [
            "stage4-idle-metrics"
          ],
          "acceptance": [
            "Checklist of scenarios completed with no display corruption; include transcript or video if possible."
          ],
          "tests": [
            "python scripts/dev/async_repl_prompt_checks.py --log docs/project_management/now/stage4_prompt_checks_transcript.txt"
          ],
          "status": "completed"
        },
        {
          "id": "stage4-observability",
          "title": "Improve mode logging/metrics",
          "description": "Emit logs/metrics noting active REPL mode and potential polling regressions for field observability.",
          "references": [
            "docs/project_management/now/Fixing REPL Busy-Spin and Implementing Async Agent Output_ Plan & Steps.docx.md (Stage 4, item 4)",
            "docs/TRACE.md",
            "docs/TELEMETRY.md"
          ],
          "files": [
            "crates/shell/src/lib.rs",
            "crates/shell/src/async_repl.rs",
            "crates/shell/Cargo.toml",
            "docs/TRACE.md"
          ],
          "dependencies": [
            "stage4-prompt-checks"
          ],
          "acceptance": [
            "Startup logs include REPL mode; telemetry counters or spans track async events.",
            "Documentation updated with new fields/toggles."
          ],
          "tests": [
            "/usr/bin/cargo test -p substrate-shell",
            "Manual: inspect trace JSON for new metadata."
          ],
          "status": "completed"
        },
        {
          "id": "stage4-rollout",
          "title": "Plan async REPL rollout",
          "description": "Outline strategy to make async mode default, add fallback flag, and retire sync loop per migration plan.",
          "references": [
            "docs/project_management/now/Fixing REPL Busy-Spin and Implementing Async Agent Output_ Plan & Steps.docx.md (Stage 4, item 5)",
            "PHASE_4_CONCURRENT_OUTPUT_DESIGN.md#L138-L155"
          ],
          "files": [
            "crates/shell/src/lib.rs",
            "scripts/dev/async_repl_prompt_checks.py",
            "scripts/dev/async_repl_metrics.py",
            "docs/USAGE.md",
            "docs/CONFIGURATION.md",
            "docs/project_management/now/Fixing REPL Busy-Spin and Implementing Async Agent Output_ Plan & Steps.docx.md"
          ],
          "dependencies": [
            "stage4-observability"
          ],
          "acceptance": [
            "Documented rollout plan with toggles, timeline, and rollback steps approved by stakeholders.",
            "Sync loop clearly marked legacy or removed once rollout complete."
          ],
          "tests": [
            "Manual: run `target/debug/substrate --legacy-repl --no-world` and confirm the prompt loads.",
            "/usr/bin/cargo test -p substrate-shell"
          ],
          "status": "completed"
        }
      ],
      "next": [
        {
          "id": "stage5-design-async-reedline",
          "title": "Finalize async Reedline adapter design",
          "description": "Document the event translation strategy for reusing Reedline in the async REPL, covering adapter responsibilities, stdout locking, and fallback modes.",
          "references": [
            "docs/project_management/now/stage5_editor_parity_plan.md",
            "docs/project_management/now/Fixing REPL Busy-Spin and Implementing Async Agent Output_ Plan & Steps.docx.md",
            "third_party/reedline"
          ],
          "files": [
            "docs/project_management/now/stage5_editor_parity_plan.md"
          ],
          "dependencies": [
            "stage4-rollout"
          ],
          "acceptance": [
            "Plan doc section 'Async Reedline Adapter' details struct/method outline and stdout locking strategy, with code references to crates/shell/src/lib.rs:1736-1928 and crates/shell/src/async_repl.rs:240-254.",
            "#design-decision section records the chosen adapter, the rejected blocking-Reedline alternative, and fallback flag guidance.",
            "Any new debug flag (e.g., --minimal-async-editor) is described in docs/USAGE.md and docs/CONFIGURATION.md."
          ],
          "tests": [
            "Manual: review updated docs/project_management/now/stage5_editor_parity_plan.md against code references.",
            "Manual: confirm fallback strategy relies on existing --legacy-repl (no new flag required)."
          ],
          "status": "completed",
          "notes": "Design locked; proceed to stage5-shared-editor-core using documented adapter surface."
        },
        {
          "id": "stage5-shared-editor-core",
          "title": "Extract shared Reedline editor core",
          "description": "Factor prompt/completer/history setup into a reusable builder used by both sync and async REPL paths, keeping feature flags aligned.",
          "references": [
            "docs/project_management/now/stage5_editor_parity_plan.md",
            "crates/shell/src/lib.rs",
            "crates/shell/src/async_repl.rs"
          ],
          "files": [
            "crates/shell/src/lib.rs",
            "crates/shell/src/async_repl.rs",
            "crates/shell/src/editor.rs"
          ],
          "dependencies": [
            "stage5-design-async-reedline"
          ],
          "acceptance": [
            "Shared builder in crates/shell/src/editor.rs (or equivalent module) constructs Reedline with prompts, keybindings, history, completer, and menus identical to legacy path.",
            "Legacy sync REPL (`target/debug/substrate --legacy-repl --no-world`) still provides Tab completion, history recall, and prompt styling post-refactor.",
            "Async path consumes the same builder without duplicating configuration."
          ],
          "tests": [
            "/usr/bin/cargo test -p substrate-shell",
            "/usr/bin/cargo fmt -- --check",
            "Manual: target/debug/substrate --legacy-repl --no-world",
            "Manual: target/debug/substrate --no-world --async-repl (default)"
          ],
          "status": "completed",
          "notes": "Shared editor module builds Reedline and returns EditorSetup { line_editor, printer } for sync/async reuse."
        },
        {
          "id": "stage5-history-completions",
          "title": "Enable history and completions in async mode",
          "description": "Wire the async REPL to the shared history backend and completion menus, including persistent storage and :demo-agent compatibility.",
          "references": [
            "docs/project_management/now/stage5_editor_parity_plan.md",
            "docs/USAGE.md"
          ],
          "files": [
            "crates/shell/src/async_repl.rs",
            "crates/shell/src/editor.rs",
            "docs/USAGE.md"
          ],
          "dependencies": [
            "stage5-shared-editor-core"
          ],
          "acceptance": [
            "Async REPL loads and syncs ~/.substrate_history via FileBackedHistory, verified by running two sessions and seeing appended commands.",
            "Tab-triggered completion menu (ColumnarMenu named 'completion_menu') renders in async mode alongside streaming agent output.",
            "Completion/history interactions during agent events leave the prompt/input intact."
          ],
          "tests": [
            "/usr/bin/cargo test -p substrate-shell",
            "/usr/bin/cargo fmt -- --check",
            "Manual: run async REPL twice, inspect ~/.substrate_history",
            "Manual: python scripts/dev/async_repl_prompt_checks.py --log docs/project_management/now/stage4_prompt_checks_transcript.txt --stage5-log docs/project_management/now/stage5_prompt_checks_transcript.txt"
          ],
          "status": "completed",
          "notes": "Async REPL now reuses Reedline via process_events; run Stage 5 prompt script when environment is available."
        },
        {
          "id": "stage5-cursor-multiline",
          "title": "Implement cursor-aware multiline editing",
          "description": "Translate crossterm input events to Reedline events inside async loop to provide left/right movement, multi-line editing, and undo/redo while streaming.",
          "references": [
            "docs/project_management/now/stage5_editor_parity_plan.md",
            "third_party/reedline/src/engine.rs"
          ],
          "files": [
            "crates/shell/src/async_repl.rs",
            "third_party/reedline/src/engine.rs"
          ],
          "dependencies": [
            "stage5-history-completions"
          ],
          "acceptance": [
            "Async REPL supports Left/Right/Home/End cursor movement and multi-line editing mapped through ReedlineEvent::Edit.",
            "Agent event redraw restores caret position for multi-line buffers under load.",
            "Undo/redo shortcuts (Ctrl+_ and Ctrl+Shift+- on Windows) operate in async mode, confirmed manually.",
            "Stage 5 scenario added to scripts/dev/async_repl_prompt_checks.py captures multi-line editing with interleaved agent output."
          ],
          "tests": [
            "/usr/bin/cargo fmt -- --check",
            "/usr/bin/cargo test -p substrate-shell -- --test-threads=1",
            "Manual: python scripts/dev/async_repl_prompt_checks.py --log docs/project_management/now/stage4_prompt_checks_transcript.txt --stage5-log docs/project_management/now/stage5_prompt_checks_transcript.txt"
          ],
          "status": "completed",
          "notes": "Async adapter now exercises Reedline cursor/multiline paths; prompt drill script captures Stage 5 scenarios."
        },
        {
          "id": "stage5-regression-validation",
          "title": "Stage 5 validation and docs",
          "description": "Extend automated tests, capture idle CPU metrics, and update docs/release notes to reflect async editor parity rollout.",
          "references": [
            "docs/project_management/now/stage5_editor_parity_plan.md",
            "docs/USAGE.md",
            "docs/CONFIGURATION.md"
          ],
          "files": [
            "crates/shell/tests",
            "docs/USAGE.md",
            "docs/CONFIGURATION.md",
            "docs/project_management/now/stage5_editor_parity_plan.md"
          ],
          "dependencies": [
            "stage5-cursor-multiline"
          ],
          "acceptance": [
            "New/updated integration tests under crates/shell/tests cover async Reedline history and cursor behavior.",
            "Idle CPU measurements saved to docs/project_management/now/stage5_idle_metrics_<platform>.txt for each OS exercised.",
            "Stage 5 prompt drill transcript stored at docs/project_management/now/stage5_prompt_checks_transcript.txt and linked in session_log.",
            "Docs/USAGE.md, docs/CONFIGURATION.md, and CHANGELOG.md describe restored editor parity and any new flags."
          ],
          "tests": [
            "/usr/bin/cargo test -p substrate-shell -- --nocapture",
            "Manual: python scripts/dev/async_repl_prompt_checks.py --log docs/project_management/now/stage5_prompt_checks_transcript.txt",
            "Manual: python scripts/dev/async_repl_metrics.py --output docs/project_management/now/stage5_idle_metrics_<platform>.txt --samples 5 (per platform)"
          ],
          "status": "pending",
          "notes": "Residual CSI cursor reports from python/sqlite3; need follow-up to audit Reedline usage and capture fresh transcripts/metrics."
        }
      ]
    }
  ],
  "next": [
    {
      "id": "stage5-design-async-reedline",
      "title": "Finalize async Reedline adapter design",
      "description": "Document the event translation strategy for reusing Reedline in the async REPL, covering adapter responsibilities, stdout locking, and fallback modes.",
      "references": [
        "docs/project_management/now/stage5_editor_parity_plan.md",
        "docs/project_management/now/Fixing REPL Busy-Spin and Implementing Async Agent Output_ Plan & Steps.docx.md",
        "third_party/reedline"
      ],
      "files": [
        "docs/project_management/now/stage5_editor_parity_plan.md"
      ],
      "dependencies": [
        "stage4-rollout"
      ],
      "acceptance": [
        "Plan doc section 'Async Reedline Adapter' details struct/method outline and stdout locking strategy, with code references to crates/shell/src/lib.rs:1736-1928 and crates/shell/src/async_repl.rs:240-254.",
        "#design-decision section records the chosen adapter, the rejected blocking-Reedline alternative, and fallback flag guidance.",
        "Any new debug flag (e.g., --minimal-async-editor) is described in docs/USAGE.md and docs/CONFIGURATION.md."
      ],
      "tests": [
        "Manual: review updated docs/project_management/now/stage5_editor_parity_plan.md against code references.",
        "Manual: confirm fallback strategy relies on existing --legacy-repl (no new flag required)."
      ],
      "status": "completed",
      "notes": "Design locked; proceed to stage5-shared-editor-core using documented adapter surface."
    },
    {
      "id": "stage5-shared-editor-core",
      "title": "Extract shared Reedline editor core",
      "description": "Factor prompt/completer/history setup into a reusable builder used by both sync and async REPL paths, keeping feature flags aligned.",
      "references": [
        "docs/project_management/now/stage5_editor_parity_plan.md",
        "crates/shell/src/lib.rs",
        "crates/shell/src/async_repl.rs"
      ],
      "files": [
        "crates/shell/src/lib.rs",
        "crates/shell/src/async_repl.rs",
        "crates/shell/src/editor.rs"
      ],
      "dependencies": [
        "stage5-design-async-reedline"
      ],
      "acceptance": [
        "Shared builder in crates/shell/src/editor.rs (or equivalent module) constructs Reedline with prompts, keybindings, history, completer, and menus identical to legacy path.",
        "Legacy sync REPL (`target/debug/substrate --legacy-repl --no-world`) still provides Tab completion, history recall, and prompt styling post-refactor.",
        "Async path consumes the same builder without duplicating configuration."
      ],
      "tests": [
        "/usr/bin/cargo test -p substrate-shell",
        "/usr/bin/cargo fmt -- --check",
        "Manual: target/debug/substrate --legacy-repl --no-world",
        "Manual: target/debug/substrate --no-world --async-repl (default)"
      ],
      "status": "completed",
      "notes": "Shared editor module builds Reedline and returns EditorSetup { line_editor, printer } for sync/async reuse."
    },
    {
      "id": "stage5-history-completions",
      "title": "Enable history and completions in async mode",
      "description": "Wire the async REPL to the shared history backend and completion menus, including persistent storage and :demo-agent compatibility.",
      "references": [
        "docs/project_management/now/stage5_editor_parity_plan.md",
        "docs/USAGE.md"
      ],
      "files": [
        "crates/shell/src/async_repl.rs",
        "crates/shell/src/editor.rs",
        "docs/USAGE.md"
      ],
      "dependencies": [
        "stage5-shared-editor-core"
      ],
      "acceptance": [
        "Async REPL loads and syncs ~/.substrate_history via FileBackedHistory, verified by running two sessions and seeing appended commands.",
        "Tab-triggered completion menu (ColumnarMenu named 'completion_menu') renders in async mode alongside streaming agent output.",
        "Completion/history interactions during agent events leave the prompt/input intact."
      ],
      "tests": [
        "/usr/bin/cargo test -p substrate-shell",
        "/usr/bin/cargo fmt -- --check",
        "Manual: run async REPL twice, inspect ~/.substrate_history",
        "Manual: python scripts/dev/async_repl_prompt_checks.py --log docs/project_management/now/stage4_prompt_checks_transcript.txt --stage5-log docs/project_management/now/stage5_prompt_checks_transcript.txt"
      ],
      "status": "completed",
      "notes": "Async REPL now reuses Reedline via process_events; run Stage 5 prompt script when environment is available."
    },
    {
      "id": "stage5-cursor-multiline",
      "title": "Implement cursor-aware multiline editing",
      "description": "Translate crossterm input events to Reedline events inside async loop to provide left/right movement, multi-line editing, and undo/redo while streaming.",
      "references": [
        "docs/project_management/now/stage5_editor_parity_plan.md",
        "third_party/reedline/src/engine.rs"
      ],
      "files": [
        "crates/shell/src/async_repl.rs",
        "third_party/reedline/src/engine.rs"
      ],
      "dependencies": [
        "stage5-history-completions"
      ],
      "acceptance": [
        "Async REPL supports Left/Right/Home/End cursor movement and multi-line editing mapped through ReedlineEvent::Edit.",
        "Agent event redraw restores caret position for multi-line buffers under load.",
        "Undo/redo shortcuts (Ctrl+_ and Ctrl+Shift+- on Windows) operate in async mode, confirmed manually.",
        "Stage 5 scenario added to scripts/dev/async_repl_prompt_checks.py captures multi-line editing with interleaved agent output."
      ],
      "tests": [
        "/usr/bin/cargo fmt -- --check",
        "/usr/bin/cargo test -p substrate-shell -- --test-threads=1",
        "Manual: python scripts/dev/async_repl_prompt_checks.py --log docs/project_management/now/stage4_prompt_checks_transcript.txt --stage5-log docs/project_management/now/stage5_prompt_checks_transcript.txt"
      ],
      "status": "completed",
      "notes": "Async adapter now exercises Reedline cursor/multiline paths; prompt drill script captures Stage 5 scenarios."
    },
    {
      "id": "stage5-regression-validation",
      "title": "Stage 5 validation and docs",
      "description": "Extend automated tests, capture idle CPU metrics, and update docs/release notes to reflect async editor parity rollout.",
      "references": [
        "docs/project_management/now/stage5_editor_parity_plan.md",
        "docs/USAGE.md",
        "docs/CONFIGURATION.md"
      ],
      "files": [
        "crates/shell/tests",
        "docs/USAGE.md",
        "docs/CONFIGURATION.md",
        "docs/project_management/now/stage5_editor_parity_plan.md"
      ],
      "dependencies": [
        "stage5-cursor-multiline"
      ],
      "acceptance": [
        "New/updated integration tests under crates/shell/tests cover async Reedline history and cursor behavior.",
        "Idle CPU measurements saved to docs/project_management/now/stage5_idle_metrics_<platform>.txt for each OS exercised.",
        "Stage 5 prompt drill transcript stored at docs/project_management/now/stage5_prompt_checks_transcript.txt and linked in session_log.",
        "Docs/USAGE.md, docs/CONFIGURATION.md, and CHANGELOG.md describe restored editor parity and any new flags."
      ],
      "tests": [
        "/usr/bin/cargo test -p substrate-shell -- --nocapture",
        "Manual: python scripts/dev/async_repl_prompt_checks.py --log docs/project_management/now/stage5_prompt_checks_transcript.txt",
        "Manual: python scripts/dev/async_repl_metrics.py --output docs/project_management/now/stage5_idle_metrics_<platform>.txt --samples 5 (per platform)"
      ],
      "status": "pending",
      "notes": "Residual CSI cursor reports from python/sqlite3; need follow-up to audit Reedline usage and capture fresh transcripts/metrics."
    }
  ]
}
