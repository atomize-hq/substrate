name: Feature Smoke (Planning Pack)

on:
  workflow_dispatch:
    inputs:
      feature_dir:
        description: "Feature Planning Pack directory (e.g., docs/project_management/next/world-sync)"
        required: true
        type: string
      checkout_ref:
        description: "Git ref to checkout for running the smoke scripts (defaults to the workflow ref)."
        required: false
        type: string
        default: ""
      runner_kind:
        description: "Where to run the smoke job(s)"
        required: true
        type: choice
        options:
          - github-hosted
          - self-hosted
        default: github-hosted
      platform:
        description: "Which platform smoke to run"
        required: true
        type: choice
        options:
          - linux
          - macos
          - windows
          - all
      run_wsl:
        description: "Also run WSL smoke (requires suitable runner)"
        required: false
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always
  RUST_TOOLCHAIN: 1.89.0

permissions:
  contents: read

jobs:
  linux_hosted:
    if: (inputs.platform == 'linux' || inputs.platform == 'all') && inputs.runner_kind == 'github-hosted'
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository (override ref)
        if: inputs.checkout_ref != ''
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.checkout_ref }}
          submodules: recursive

      - name: Checkout repository
        if: inputs.checkout_ref == ''
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq ripgrep pkg-config libseccomp-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          components: rustfmt, clippy

      - name: Build substrate (debug)
        run: cargo build --bin substrate

      - name: Add substrate to PATH
        run: echo "$GITHUB_WORKSPACE/target/debug" >> "$GITHUB_PATH"

      - name: Run linux smoke
        run: bash "${{ inputs.feature_dir }}/smoke/linux-smoke.sh"

  linux_self_hosted:
    if: (inputs.platform == 'linux' || inputs.platform == 'all') && inputs.runner_kind == 'self-hosted'
    runs-on: [self-hosted, Linux]
    steps:
      - name: Checkout repository (override ref)
        if: inputs.checkout_ref != ''
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.checkout_ref }}
          submodules: recursive

      - name: Checkout repository
        if: inputs.checkout_ref == ''
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          components: rustfmt, clippy

      - name: Preflight native deps (Linux)
        run: |
          if ! command -v pkg-config >/dev/null 2>&1; then
            echo "Missing pkg-config. Install it (e.g., pkgconf/pkg-config) on this runner." >&2
            exit 1
          fi
          if ! pkg-config --exists libseccomp; then
            echo "Missing libseccomp development package on this runner." >&2
            echo "  - Ubuntu/Debian: sudo apt-get install -y libseccomp-dev pkg-config" >&2
            echo "  - Manjaro/Arch:  sudo pacman -Syu --needed libseccomp pkgconf" >&2
            exit 1
          fi

      - name: Build substrate (debug)
        run: cargo build --bin substrate

      - name: Add substrate to PATH
        run: echo "$GITHUB_WORKSPACE/target/debug" >> "$GITHUB_PATH"

      - name: Run linux smoke
        run: bash "${{ inputs.feature_dir }}/smoke/linux-smoke.sh"

  macos_hosted:
    if: (inputs.platform == 'macos' || inputs.platform == 'all') && inputs.runner_kind == 'github-hosted'
    runs-on: macos-14
    steps:
      - name: Checkout repository (override ref)
        if: inputs.checkout_ref != ''
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.checkout_ref }}
          submodules: recursive

      - name: Checkout repository
        if: inputs.checkout_ref == ''
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          if ! command -v jq >/dev/null 2>&1; then brew install jq; fi
          if ! command -v rg >/dev/null 2>&1; then brew install ripgrep; fi

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          components: rustfmt, clippy

      - name: Build substrate (debug)
        run: cargo build --bin substrate

      - name: Add substrate to PATH
        run: echo "$GITHUB_WORKSPACE/target/debug" >> "$GITHUB_PATH"

      - name: Run macOS smoke
        run: bash "${{ inputs.feature_dir }}/smoke/macos-smoke.sh"

  macos_self_hosted:
    if: (inputs.platform == 'macos' || inputs.platform == 'all') && inputs.runner_kind == 'self-hosted'
    runs-on: [self-hosted, macOS]
    steps:
      - name: Checkout repository (override ref)
        if: inputs.checkout_ref != ''
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.checkout_ref }}
          submodules: recursive

      - name: Checkout repository
        if: inputs.checkout_ref == ''
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          components: rustfmt, clippy

      - name: Build substrate (debug)
        run: cargo build --bin substrate

      - name: Add substrate to PATH
        run: echo "$GITHUB_WORKSPACE/target/debug" >> "$GITHUB_PATH"

      - name: Run macOS smoke
        run: bash "${{ inputs.feature_dir }}/smoke/macos-smoke.sh"

  windows_hosted:
    if: (inputs.platform == 'windows' || inputs.platform == 'all') && inputs.runner_kind == 'github-hosted'
    runs-on: windows-2022
    steps:
      - name: Checkout repository (override ref)
        if: inputs.checkout_ref != ''
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.checkout_ref }}
          submodules: recursive

      - name: Checkout repository
        if: inputs.checkout_ref == ''
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          components: rustfmt, clippy

      - name: Build substrate (debug)
        run: cargo build --bin substrate

      - name: Add substrate to PATH
        shell: pwsh
        run: Add-Content -LiteralPath $env:GITHUB_PATH -Value "$pwd\\target\\debug"

      - name: Run Windows smoke
        shell: pwsh
        run: pwsh -File "${{ inputs.feature_dir }}/smoke/windows-smoke.ps1"

  windows_self_hosted:
    if: (inputs.platform == 'windows' || inputs.platform == 'all') && inputs.runner_kind == 'self-hosted'
    runs-on: [self-hosted, Windows]
    steps:
      - name: Checkout repository (override ref)
        if: inputs.checkout_ref != ''
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.checkout_ref }}
          submodules: recursive

      - name: Checkout repository
        if: inputs.checkout_ref == ''
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Ensure Rust toolchain (self-hosted)
        shell: pwsh
        run: |
          if (-not (Get-Command rustup -ErrorAction SilentlyContinue)) {
            throw "rustup not found on PATH. Install Rust via rustup-init.exe, then restart the runner service."
          }
          rustup toolchain install $env:RUST_TOOLCHAIN --profile minimal
          rustup component add rustfmt clippy --toolchain $env:RUST_TOOLCHAIN
          Add-Content -LiteralPath $env:GITHUB_ENV -Value "RUSTUP_TOOLCHAIN=$env:RUST_TOOLCHAIN"
          rustc --version
          cargo --version

      - name: Build substrate (debug)
        run: cargo build --bin substrate

      - name: Add substrate to PATH
        shell: pwsh
        run: Add-Content -LiteralPath $env:GITHUB_PATH -Value "$pwd\\target\\debug"

      - name: Run Windows smoke
        shell: pwsh
        run: pwsh -File "${{ inputs.feature_dir }}/smoke/windows-smoke.ps1"

  wsl:
    if: inputs.run_wsl
    runs-on: [self-hosted, Linux, wsl]
    steps:
      - name: Checkout repository (override ref)
        if: inputs.checkout_ref != ''
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.checkout_ref }}
          submodules: recursive

      - name: Checkout repository
        if: inputs.checkout_ref == ''
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          components: rustfmt, clippy

      - name: Preflight native deps (WSL runner)
        run: |
          if ! command -v pkg-config >/dev/null 2>&1; then
            echo "Missing pkg-config. Install it on this runner." >&2
            exit 1
          fi
          if ! pkg-config --exists libseccomp; then
            echo "Missing libseccomp development package on this runner." >&2
            exit 1
          fi

      - name: Build substrate (debug)
        run: cargo build --bin substrate

      - name: Add substrate to PATH
        run: echo "$GITHUB_WORKSPACE/target/debug" >> "$GITHUB_PATH"

      - name: Run WSL (Linux) smoke
        run: bash "${{ inputs.feature_dir }}/smoke/linux-smoke.sh"
