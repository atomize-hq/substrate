# Lima configuration for Substrate (dev profile) on macOS
# Heavier resources for development and debugging.
# Usage example (from repository root):
#   PROJECT="$(pwd)" envsubst < scripts/mac/lima/substrate-dev.yaml > /tmp/substrate-dev.yaml
#   limactl start --tty=false --name substrate /tmp/substrate-dev.yaml

images:
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-arm64.img"
    arch: "aarch64"
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-amd64.img"
    arch: "x86_64"

vmType: "vz"
rosetta:
  enabled: true
cpus: 6
memory: "8GiB"
disk: "40GiB"
mounts:
  - location: "$HOME"
    writable: false
  - location: "$PROJECT"
    writable: true
    mountPoint: "/src"
provision:
  - mode: system
    script: |
      #!/bin/sh
      set -eux
      apt-get update
      DEBIAN_FRONTEND=noninteractive apt-get install -y \
        nftables iproute2 libseccomp-dev curl jq git \
        openssh-server dnsmasq unzip build-essential pkg-config libssl-dev python3 python3-pip
      # Optional dev conveniences (safe to remove for runtime)
      DEBIAN_FRONTEND=noninteractive apt-get install -y tmux
      systemctl disable --now systemd-resolved || true
      cat >/etc/dnsmasq.d/substrate.conf <<'EOF'
      port=53
      listen-address=127.0.0.53
      bind-interfaces
      no-resolv
      server=1.1.1.1
      server=1.0.0.1
      cache-size=1000
      EOF
      echo 'nameserver 127.0.0.53' > /etc/resolv.conf
      sysctl -w kernel.unprivileged_userns_clone=1 || true
      mkdir -p /var/lib/substrate/overlay /run/substrate
      # Ensure hostname resolves to silence sudo warnings
      (hostnamectl set-hostname lima-substrate || true)
      grep -q 'lima-substrate' /etc/hosts || echo '127.0.1.1 lima-substrate' >> /etc/hosts
      # Systemd unit for the world agent
      cat >/etc/systemd/system/substrate-world-agent.service <<'EOF'
      [Unit]
      Description=Substrate World Agent
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=simple
      ExecStart=/usr/local/bin/substrate-world-agent
      Restart=always
      RestartSec=5
      Environment=RUST_LOG=info
      RuntimeDirectory=substrate
      RuntimeDirectoryMode=0750
      StateDirectory=substrate
      StateDirectoryMode=0750
      WorkingDirectory=/var/lib/substrate
      StandardOutput=journal
      StandardError=journal
      NoNewPrivileges=yes
      ProtectSystem=strict
      ProtectHome=read-only
      ReadWritePaths=/var/lib/substrate /run /run/substrate /sys/fs/cgroup /tmp
      CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_SYS_ADMIN CAP_SYS_CHROOT CAP_DAC_OVERRIDE
      AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_SYS_ADMIN CAP_SYS_CHROOT CAP_DAC_OVERRIDE

      [Install]
      WantedBy=multi-user.target
      EOF
      chmod 644 /etc/systemd/system/substrate-world-agent.service
      cat >/etc/systemd/system/substrate-world-agent.socket <<'EOF'
      [Unit]
      Description=Substrate World Agent Socket
      PartOf=substrate-world-agent.service

      [Socket]
      ListenStream=/run/substrate.sock
      SocketMode=0660
      SocketUser=root
      SocketGroup=substrate
      DirectoryMode=0750
      RemoveOnStop=yes
      Service=substrate-world-agent.service

      [Install]
      WantedBy=sockets.target
      EOF
      chmod 644 /etc/systemd/system/substrate-world-agent.socket
      systemctl daemon-reload
      # Binary copied later; service enabled during Phase 0.4
