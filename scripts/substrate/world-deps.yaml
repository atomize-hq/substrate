version: 1
managers:
  git:
    summary: "Git CLI"
    detect:
      commands:
        - "git --version"
    guest_detect:
      command: "git --version"
    guest_install:
      apt: |
        sudo apt-get update
        sudo apt-get install -y git

  node:
    summary: "Node.js runtime + npm"
    detect:
      commands:
        - "node --version"
        - "npm --version"
    guest_detect:
      command: "node --version"
    guest_install:
      custom: |
        set -euo pipefail
        ROOT="${SUBSTRATE_WORLD_DEPS_PREFIX:-/var/lib/substrate/world-deps}"
        BIN_DIR="${SUBSTRATE_WORLD_DEPS_GUEST_BIN_DIR:-${ROOT}/bin}"
        CACHE_DIR="${ROOT}/cache"
        INSTALL_DIR="${ROOT}/node"

        mkdir -p "${BIN_DIR}" "${CACHE_DIR}" "${INSTALL_DIR}"

        arch="$(uname -m)"
        case "${arch}" in
          x86_64|amd64) node_arch="x64" ;;
          aarch64|arm64) node_arch="arm64" ;;
          *) echo "unsupported arch: ${arch}" >&2; exit 1 ;;
        esac

        version="$(
          curl -fsSL https://nodejs.org/dist/index.json | python3 -c 'import json,sys; data=json.load(sys.stdin); v=[x["version"].lstrip("v") for x in data if x.get("version","").startswith("v20.")]; v.sort(key=lambda s: [int(p) for p in s.split(".")], reverse=True); print(v[0])'
        )"

        tarball="node-v${version}-linux-${node_arch}.tar.xz"
        url="https://nodejs.org/dist/v${version}/${tarball}"
        curl -fsSL -o "${CACHE_DIR}/${tarball}" "${url}"

        rm -rf "${INSTALL_DIR}/node-v${version}-linux-${node_arch}"
        tar --no-same-owner --no-same-permissions -xJf "${CACHE_DIR}/${tarball}" -C "${INSTALL_DIR}"

        ln -sf "${INSTALL_DIR}/node-v${version}-linux-${node_arch}/bin/node" "${BIN_DIR}/node"
        ln -sf "${INSTALL_DIR}/node-v${version}-linux-${node_arch}/bin/npm" "${BIN_DIR}/npm"
        ln -sf "${INSTALL_DIR}/node-v${version}-linux-${node_arch}/bin/npx" "${BIN_DIR}/npx"

  python:
    summary: "Python 3 runtime"
    detect:
      commands:
        - "python --version"
        - "python3 --version"
    guest_detect:
      command: "python --version"
    guest_install:
      custom: |
        set -euo pipefail
        ROOT="${SUBSTRATE_WORLD_DEPS_PREFIX:-/var/lib/substrate/world-deps}"
        BIN_DIR="${SUBSTRATE_WORLD_DEPS_GUEST_BIN_DIR:-${ROOT}/bin}"

        mkdir -p "${BIN_DIR}"

        if ! command -v python3 >/dev/null 2>&1; then
          echo "python3 is missing inside the guest; install Python 3 via the base VM image/provisioning." >&2
          exit 1
        fi

        ln -sf "$(command -v python3)" "${BIN_DIR}/python"
